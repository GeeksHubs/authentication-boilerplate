var di=Object.create;var ze=Object.defineProperty,ci=Object.defineProperties,mi=Object.getOwnPropertyDescriptor,fi=Object.getOwnPropertyDescriptors,gi=Object.getOwnPropertyNames,No=Object.getOwnPropertySymbols,hi=Object.getPrototypeOf,Go=Object.prototype.hasOwnProperty,yi=Object.prototype.propertyIsEnumerable;var Uo=(t,e,r)=>e in t?ze(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,x=(t,e)=>{for(var r in e||(e={}))Go.call(e,r)&&Uo(t,r,e[r]);if(No)for(var r of No(e))yi.call(e,r)&&Uo(t,r,e[r]);return t},q=(t,e)=>ci(t,fi(e)),Ko=t=>ze(t,"__esModule",{value:!0});var ae=(t,e)=>{for(var r in e)ze(t,r,{get:e[r],enumerable:!0})},Wo=(t,e,r,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of gi(e))!Go.call(t,s)&&(r||s!=="default")&&ze(t,s,{get:()=>e[s],enumerable:!(o=mi(e,s))||o.enumerable});return t},S=(t,e)=>Wo(Ko(ze(t!=null?di(hi(t)):{},"default",!e&&t&&t.__esModule?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t),bi=(t=>(e,r)=>t&&t.get(e)||(r=Wo(Ko({}),e,1),t&&t.set(e,r),r))(typeof WeakMap!="undefined"?new WeakMap:0);var fo={};ae(fo,{ActionType:()=>N,ExecuteHook:()=>He,HttpSymbolKind:()=>j,LogLevel:()=>Ee,OnRequestHook:()=>Re,OnResponseHook:()=>ke,OnStreaming:()=>Pe,ParseEndRegionHook:()=>wt,ParseHook:()=>xt,ProtoDefinition:()=>Ct,ProvideEnvironmentsHook:()=>kt,ProvideVariablesHook:()=>Rt,RepeatOrder:()=>Ht,ReplaceVariableHook:()=>Pt,ResponseLoggingHook:()=>Ce,VariableType:()=>ye,actions:()=>he,cli:()=>_o,createEmptyProcessorContext:()=>Je,getEnvironments:()=>Dl,getVariables:()=>Jn,io:()=>fe,isProcessorContext:()=>$e,parser:()=>Yt,send:()=>or,store:()=>Gr,testSymbols:()=>le,utils:()=>v,variables:()=>jo});var fe={};ae(fe,{Logger:()=>Ye,fileProvider:()=>f,log:()=>c,userInteractionProvider:()=>O});var f={exists:()=>{throw new Error("Not Implemented")},dirname:()=>{throw new Error("Not Implemented")},hasExtension:()=>{throw new Error("Not Implemented")},isAbsolute:()=>{throw new Error("Not Implemented")},joinPath:()=>{throw new Error("Not Implemented")},readFile:()=>{throw new Error("Not Implemented")},readBuffer:()=>{throw new Error("Not Implemented")},writeBuffer:()=>{throw new Error("Not Implemented")},readdir:()=>{throw new Error("Not Implemented")},fsPath:Jo,toString:Jo};function Jo(t){return typeof t=="string"?t:t.toString()}var J=require("hookpoint"),xt=class extends J.LastOutHook{constructor(){super(e=>!!e);this.id="ParseHook"}},wt=class extends J.SeriesHook{constructor(){super();this.id="ParseEndRegionHook"}},Rt=class extends J.SeriesHook{constructor(){super();this.id="ProvideVariablesHook"}},kt=class extends J.SeriesHook{constructor(){super();this.id="ProvideEnvironmentsHook"}},Pt=class extends J.WaterfallHook{constructor(){super(e=>e===void 0);this.id="ReplaceVariableHook"}},Re=class extends J.SeriesHook{constructor(){super();this.id="BeforeRequestHook"}},ke=class extends J.SeriesHook{constructor(){super();this.id="AfterRequestHook"}},Pe=class extends J.SeriesHook{constructor(){super();this.id="OnStreaming"}},Ce=class extends J.SeriesHook{constructor(){super();this.id="ResponseLoggingHook"}},He=class extends J.SeriesHook{constructor(){super(e=>!e);this.id="ExecuteHook"}};var N=(w=>(w.cookieJar="cookieJar",w.defaultHeaders="defaultHeaders",w.eventSourceClient="eventSourceClient",w.intellij="intellij",w.gql="gql",w.loop="loop",w.js="js",w.protoImport="protoImport",w.protoCreate="protoCreate",w.grpcClient="grpcClient",w.httpClient="httpClient",w.import="import",w.ref="ref",w.variable="variable",w.websocketClient="websocketClient",w))(N||{});var j=(k=>(k.request="request",k.requestLine="requestLine",k.requestHeader="requestHeader",k.requestBody="requestBody",k.response="response",k.gql="gql",k.proto="proto",k.script="script",k.metaData="metaData",k.comment="comment",k.url="url",k.operator="operator",k.key="key",k.value="value",k.variable="variable",k.text="text",k))(j||{});var Ee=(i=>(i[i.trace=1]="trace",i[i.debug=2]="debug",i[i.warn=5]="warn",i[i.info=10]="info",i[i.error=100]="error",i[i.none=1e3]="none",i))(Ee||{});function $e(t){let e=t;return!!(e==null?void 0:e.httpClient)&&!!(e==null?void 0:e.httpRegion)&&!!(e==null?void 0:e.httpFile)&&!!(e==null?void 0:e.variables)&&!!(e==null?void 0:e.config)}var Ct=class{constructor(e){this.fileName=e;this.loaderOptions={}}};var Ht=(r=>(r[r.sequential=0]="sequential",r[r.parallel=1]="parallel",r))(Ht||{});var le={ok:"\u2713",error:"\u2716"};var ye=(s=>(s.variable="Variable",s.url="Url",s.body="Body",s.filePath="FilePath",s))(ye||{});var Ye=class{constructor(e){this.options=e}collectMessages(){this.options.onlyFailedTests&&(this.collectCache=[])}flush(){if(this.collectCache){for(let e of this.collectCache)e();delete this.collectCache}}writeLog(e,r,o){var s,n;if(!((s=this.options)==null?void 0:s.level)||e>=this.options.level){let i=()=>r(...o);((n=this.options)==null?void 0:n.logMethod)&&(i=()=>{var a,l;return(l=(a=this.options)==null?void 0:a.logMethod)==null?void 0:l.call(a,e,...o)}),this.collectCache?this.collectCache.push(i):i()}}info(...e){this.writeLog(10,console.info,e)}log(...e){this.writeLog(10,console.log,e)}trace(...e){this.writeLog(1,this.options.noTrace?console.debug:console.trace,e)}debug(...e){this.writeLog(2,console.debug,e)}error(...e){this.writeLog(100,console.error,e)}warn(...e){this.writeLog(5,console.warn,e)}logTest(e,r){var o;!((o=this.options)==null?void 0:o.onlyFailedTests)&&e?this.writeLog(10,console.info,[r]):e||this.writeLog(10,console.error,[r])}clear(){console.clear()}},c=new Ye({level:5,noTrace:!0});var O={showNote:async function(){throw new Error("Not Implemented")},showInputPrompt:async function(){throw new Error("Not Implemented")},showListPrompt:async function(){throw new Error("Not Implemented")}};var he={};ae(he,{CookieJarInterceptor:()=>At,CreateRequestBodyInterceptor:()=>Gt,CreateRequestInterceptor:()=>Ft,DefaultHeadersAction:()=>jt,EventSourceClientAction:()=>Dt,GqlAction:()=>Mt,GrpcClientAction:()=>Vt,HttpClientAction:()=>Bt,ImportMetaAction:()=>Ut,IntellijAction:()=>Nt,LoopMetaAction:()=>_t,LoopMetaType:()=>Jr,RefMetaAction:()=>Kt,WebSocketClientAction:()=>Wt,attachDefaultHeaders:()=>Kr,requestVariableReplacer:()=>to,responseAsVariable:()=>Xr,setEnvRequestOptions:()=>eo,transformRequestBody:()=>ro});var Gr={};ae(Gr,{HttpFileStore:()=>Be,UserSessionStore:()=>Ur,getEnvironmentConfig:()=>ft,pluginStore:()=>Ve,userSessionStore:()=>E});var v={};ae(v,{ENVIRONMENT_NONE:()=>os,JAVASCRIPT_KEYWORDS:()=>ts,assertHasNoResponseBody:()=>Rr,assertHasResponseBody:()=>wr,assertHeaderContains:()=>xr,assertHeaderEquals:()=>vr,assertMaxTotalTime:()=>br,assertResponseBodyEquals:()=>kr,assertResponsetimeLower:()=>Pi,assertStatusEquals:()=>yr,clearModule:()=>Or,cloneResponse:()=>it,decodeJWT:()=>Oe,defaultConfigFiles:()=>Et,deleteHeader:()=>fr,deleteVariableInContext:()=>mt,equalsPath:()=>Hr,evalExpression:()=>Q,executeGlobalScripts:()=>Me,expandVariable:()=>It,extensionName:()=>Pr,findRootDir:()=>Lt,findRootDirOfFile:()=>Cr,getDisplayName:()=>dt,getHeader:()=>$,getHeaderArray:()=>Se,getHttpyacConfig:()=>Tr,getMarkdownSyntax:()=>hs,getPlugins:()=>Er,getRegionDescription:()=>jr,gotHttpClientFactory:()=>us,initHttpClient:()=>Ar,isError:()=>$r,isEventSourceRequest:()=>dr,isGlobalHttpRegion:()=>De,isGrpcRequest:()=>mr,isHttpRegionSendContext:()=>Dr,isHttpRegionsSendContext:()=>Mr,isHttpRequest:()=>W,isHttpRequestMethod:()=>St,isHttpResponse:()=>hr,isMQTTRequest:()=>cr,isMimeTypeCSS:()=>ir,isMimeTypeFormUrlEncoded:()=>rt,isMimeTypeHtml:()=>nr,isMimeTypeImage:()=>xi,isMimeTypeJSON:()=>Xe,isMimeTypeJavascript:()=>sr,isMimeTypeMarkdown:()=>tt,isMimeTypeMultiPartFormData:()=>ar,isMimeTypeNewlineDelimitedJSON:()=>lr,isMimeTypePdf:()=>vi,isMimeTypeXml:()=>et,isProcessorContext:()=>Vi,isPromise:()=>Ae,isString:()=>m,isStringEmpty:()=>K,isWebsocketRequest:()=>st,iterateDirectoryTree:()=>qt,iterateUntilRoot:()=>Ot,joinMarkdown:()=>$t,loadModule:()=>Tt,logResponse:()=>G,mergeRawHttpHeaders:()=>ji,parseContentType:()=>Le,parseError:()=>Ir,parseJson:()=>ut,parseMimeType:()=>Ze,processHttpRegionActions:()=>ve,replaceFilePath:()=>ne,replaceInvalidChars:()=>Ci,replaceVariables:()=>de,report:()=>h,requestLoggerFactory:()=>gr,resolveClientCertificates:()=>rs,resolveModule:()=>Lr,runScript:()=>je,setAdditionalResponseBody:()=>at,setVariableInContext:()=>V,shortenFileName:()=>Hi,shrinkCloneResponse:()=>nt,sleep:()=>pe,stateGenerator:()=>Ie,testFactory:()=>ct,toAbsoluteFilename:()=>M,toEnvironmentKey:()=>U,toHttpString:()=>Bi,toHttpStringHeader:()=>Vr,toHttpStringRequest:()=>ms,toHttpStringResponse:()=>cs,toMarkdown:()=>_i,toMarkdownHeader:()=>Br,toMarkdownMeta:()=>vs,toMarkdownRequest:()=>ys,toMarkdownResponse:()=>gs,toMarkdownTestResults:()=>bs,toMarkdownTimings:()=>xs,toMultiLineArray:()=>be,toMultiLineString:()=>F,toNumber:()=>ur,toProcessedHttpRegion:()=>ds,toQueryParams:()=>D,toString:()=>ot,triggerRequestResponseHooks:()=>se,unsetVariableInContext:()=>qe});function Ze(t){var s;let[e,...r]=t.split(";").map(n=>n.trim()),o=(s=r.find(n=>n.startsWith("charset=")))==null?void 0:s.split("=")[1];return{mimeType:e,contentType:t,charset:o}}function Xe(t){return!!t&&(t.mimeType==="application/json"||t.mimeType.indexOf("+json")>=0||t.mimeType.indexOf("x-amz-json")>=0)}function sr(t){return(t==null?void 0:t.mimeType)==="application/javascript"||(t==null?void 0:t.mimeType)==="text/x-javascript"}function et(t){return!!t&&(t.mimeType==="application/xml"||t.mimeType==="text/xml"||t.mimeType.indexOf("+xml")>=0)}function nr(t){return(t==null?void 0:t.mimeType)==="text/html"}function ir(t){return(t==null?void 0:t.mimeType)==="text/css"}function tt(t){return(t==null?void 0:t.mimeType)==="text/markdown"}function ar(t){return(t==null?void 0:t.mimeType)==="multipart/form-data"}function lr(t){return(t==null?void 0:t.mimeType)==="application/x-ndjson"}function rt(t){return(t==null?void 0:t.mimeType)==="application/x-www-form-urlencoded"}function vi(t){return(t==null?void 0:t.mimeType)==="application/pdf"}function xi(t){return t?["image/jpeg","image/gif","image/webp","image/png","image/bmp"].indexOf(t.mimeType)>=0:!1}var Qo=require("os");function F(t){return t.join(Qo.EOL)}function be(t){return t.split(/\r?\n/gu)}function m(t){return typeof t=="string"}function ur(t,e){if(t){let r=Number.parseInt(t,10);if(!Number.isNaN(r))return r}return e}function K(t){return typeof t=="string"&&/^(\s*)?$/u.test(t)}function Ie(t=30){let e="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",r=[];for(let o=t;o>0;--o)r.push(e[Math.floor(Math.random()*e.length)]);return r.join("")}function ot(t){if(m(t)||typeof t=="number")return`${t}`;if(t instanceof Date)return t.toISOString();if(t)return JSON.stringify(t)}var oe=S(require("chalk")),pr=require("hookpoint"),zo=require("util"),Yo=S(require("xml-formatter"));function St(t){return t?["GET","POST","PUT","DELETE","PATCH","HEAD","OPTIONS","CONNECT","TRACE","PROPFIND","PROPPATCH","MKCOL","COPY","MOVE","LOCK","UNLOCK","CHECKOUT","CHECKIN","REPORT","MERGE","MKACTIVITY","MKWORKSPACE","VERSION-CONTROL","BASELINE-CONTROL"].includes(t.toUpperCase()):!1}function W(t){return St(t==null?void 0:t.method)}function st(t){return(t==null?void 0:t.method)==="WS"}function dr(t){return(t==null?void 0:t.method)==="SSE"}function cr(t){return(t==null?void 0:t.method)==="MQTT"}function mr(t){return(t==null?void 0:t.method)==="GRPC"}function fr(t,...e){if(t)for(let r of e){let o=Object.entries(t).find(([s])=>s.toLowerCase()===r.toLowerCase());o&&o.length>1&&delete t[o[0]]}}function $(t,e){if(t){let r=Object.entries(t).find(([o])=>o.toLowerCase()===e.toLowerCase());if(r&&r.length>1)return r[1]}}function Se(t,e){let r=$(t,e);if(r)return m(r)?[r]:r}function Le(t){let e=$(t,"content-type");if(m(e))return Ze(e)}function Oe(t){try{let e=t.split(".");if(e.length!==3)return null;let r=e[1];switch(r=r.replace(/-/gu,"+"),r=r.replace(/_/gu,"/"),r.length%4){case 0:break;case 2:r+="==";break;case 3:r+="=";break;default:return null}let o=new zo.TextDecoder().decode(Buffer.from(r,"base64"));return JSON.parse(o)}catch(e){return c.warn(e),null}}function D(t){return Object.entries(t).filter(([,e])=>!!e).map(([e,r])=>`${e}=${encodeURIComponent(r||"")}`).join("&")}function gr(t,e,r){return async function(s,n){var a,l,u,p,d,b,y,C;let i=e;if(r&&(n==null?void 0:n.testResults)&&n.testResults.some(w=>!w.result)&&(i=r),!(i.onlyFailed&&(!(n==null?void 0:n.testResults)||n.testResults.every(w=>w.result))))if(t(""),t("---------------------"),t(""),(((a=n==null?void 0:n.metaData)==null?void 0:a.title)||((l=n==null?void 0:n.metaData)==null?void 0:l.description))&&(((u=n==null?void 0:n.metaData)==null?void 0:u.title)&&t(oe.default`{gray === ${n.metaData.title} ===}`),((p=n==null?void 0:n.metaData)==null?void 0:p.description)&&t(oe.default`{gray ${n.metaData.description}}`),t("")),i.useShort)t(oe.default`{yellow ${((d=s.request)==null?void 0:d.method)||"GET"}} {gray ${((b=s.request)==null?void 0:b.url)||"?"}}`),t(oe.default`{gray =>} {cyan.bold ${s.statusCode}} ({yellow ${((y=s.timings)==null?void 0:y.total)||"?"} ms}, {yellow ${((C=s.meta)==null?void 0:C.size)||"?"}})`);else{let w=[];if(s.request&&i.requestOutput&&w.push(...Ri(s.request,{headers:i.requestHeaders,bodyLength:i.requestBodyLength})),i.responseHeaders&&(w.length>0&&w.push(""),w.push(...ki(s))),m(s.body)&&i.responseBodyLength!==void 0){w.length>0&&w.push("");let k=s.body;e.responseBodyPrettyPrint&&s.prettyPrintBody&&(k=s.prettyPrintBody),k=Zo(k,i.responseBodyLength),w.push(k)}t(F(w))}}}function Zo(t,e){let r=t;return e>0&&(r=t.slice(0,Math.min(t.length,e)),t.length>=e&&(r+=`... (${t.length-e} characters  more)`)),r}function Ri(t,e){var o,s;let r=[];return r.push(oe.default`{cyan.bold ${t.method} ${t.url}}`),t.headers&&e.headers&&r.push(...Object.entries(t.headers).map(([n,i])=>oe.default`{yellow ${n}}: ${i}`).sort()),W(t)&&(((o=t.https)==null?void 0:o.certificate)||((s=t.https)==null?void 0:s.pfx))&&r.push(oe.default`{yellow client-cert}: true`),m(t.body)&&e.bodyLength!==void 0&&(r.push(""),r.push(oe.default`{gray ${Zo(t.body,e.bodyLength)}}`)),r}function ki(t){let e=[];return e.push(oe.default`{cyan.bold ${t.protocol}} {cyan.bold ${t.statusCode}} {bold ${t.statusMessage?` - ${t.statusMessage}`:""}}`),t.headers&&e.push(...Object.entries(t.headers).filter(([r])=>!r.startsWith(":")).map(([r,o])=>oe.default`{yellow ${r}}: ${o}`).sort()),e}function hr(t){let e=t;return!!(e==null?void 0:e.statusCode)}function nt(t){let e=it(t);return delete e.rawBody,delete e.prettyPrintBody,delete e.request,e}function it(t){let e={protocol:t.protocol,statusCode:t.statusCode,statusMessage:t.statusMessage,httpVersion:t.httpVersion,headers:t.headers,body:t.body,rawHeaders:t.rawHeaders,rawBody:t.rawBody,parsedBody:t.parsedBody,prettyPrintBody:t.prettyPrintBody,contentType:t.contentType,timings:t.timings,meta:t.meta};return t.request&&(e.request=x({},t.request)),e}function at(t,e){var r;if(m(t.body)&&t.body.length>0){let o=((r=e==null?void 0:e.config)==null?void 0:r.requestPrettyPrintBodyMaxSize)||1e6;if(Xe(t.contentType))try{t.parsedBody||(t.parsedBody=JSON.parse(t.body)),!t.prettyPrintBody&&t.body.length<o&&(t.prettyPrintBody=JSON.stringify(t.parsedBody,null,2))}catch(s){c.warn("json parse error",t.body,s)}else if(et(t.contentType)&&!t.prettyPrintBody&&t.body.length<o)try{t.prettyPrintBody=(0,Yo.default)(t.body,{collapseContent:!0,indentation:"  "})}catch(s){c.warn("xml format error",t.body,s)}}}async function se(t,e){var r;try{let o=e.httpFile.hooks.onRequest.merge(e.httpRegion.hooks.onRequest);if(e.request&&await o.trigger(e.request,e)===pr.HookCancel)return!1;let s=await t();if(s){if(await e.httpRegion.hooks.onResponse.merge(e.httpFile.hooks.onResponse).trigger(s,e)===pr.HookCancel)return!1;e.httpRegion.response=s}return!0}catch(o){throw c.error((r=e.request)==null?void 0:r.url,e.request,o),o}}var ue=require("assert");function yr(t,e){(0,ue.strictEqual)(t.statusCode,e,`response status equals to ${e}`)}function br(t,e){var r;(0,ue.ok)(((r=t.timings)==null?void 0:r.total)?t.timings.total<e:!0,`total time exceeded ${e}`)}function vr(t,e,r){let o=$(t.headers,e);(0,ue.strictEqual)(o,r,`response header equals ${r}`)}function xr(t,e,r){let o=$(t.headers,e);(m(o)||Array.isArray(o))&&(0,ue.ok)(o.indexOf(r),`response header contains ${r}`)}function Pi(t,e){var r;((r=t.timings)==null?void 0:r.total)&&(0,ue.ok)(t.timings.total<=e,`response time lower ${e}`)}function wr(t){(0,ue.ok)(!!t.body,"response body exists")}function Rr(t){(0,ue.ok)(!t.body,"response body does not exists")}function kr(t,e){(0,ue.strictEqual)(t.body,e,`response body equals ${e}`)}async function M(t,e){if(t){if(await f.isAbsolute(t)&&await f.exists(t))return t;if(e&&m(t)){let r=f.joinPath(e,t);if(await f.exists(r))return r}}}function Pr(t){let e=f.toString(t),r=e.lastIndexOf(".");if(r>0&&r<e.length-2)return e.slice(r+1)}function Ci(t){return t.replace(/[/\\?%*:|"<>]/gu,"_").split("_").filter(r=>r.length>0).join("_")}function Hi(t,e=50){let r=[],o=0;for(let n of t.split("_").reverse())n.length+o<e?(r.push(n),o+=n.length+1):r.length===0&&r.push(n);let s=r.reverse().join("_");return s.slice(Math.max(s.length-e,0))}async function Cr(t,e,...r){let o=t,s=f.fsPath(t);!await f.isAbsolute(t)&&e&&s&&(o=f.joinPath(e,s));let n=f.dirname(o),i=await Lt(n,...r);return i||i||e}async function Lt(t,...e){return qt(t,async r=>{let o=await f.readdir(r);if(o.some(s=>e.indexOf(s)>=0))return!0;for(let s of e)if(o.some(n=>s.startsWith(n))&&await f.exists(f.joinPath(r,s)))return!0;return!1})}async function Ot(t,e,r){return qt(t,async o=>(await r(o),!!e&&Hr(e,o)))}async function qt(t,e){if(t){if(await e(t))return t;if(!Hr(f.dirname(t),t))return qt(f.dirname(t),e)}}function Hr(t,e){return!!t&&!!e&&f.toString(t)===f.toString(e)}function Ae(t){let e=t;return e&&!!e.then}function pe(t){return new Promise(e=>setTimeout(e,t))}var Fe=S(require("module")),es=require("os"),lt=S(require("path")),Sr=S(require("vm"));function Lr(t,e){let r;try{try{r=Fe.default.createRequire(lt.default.resolve(e,"package.json")).resolve(t)}catch{r=require.resolve(t,{paths:[e]})}}catch(o){c.debug(o)}return r}function Tt(t,e,r=!1){try{return r&&Or(t,e),Fe.default.createRequire(lt.default.resolve(e,"package.json"))(t)}catch{let s=Lr(t,e);if(s)return r&&qr(s),require(s)}}function Si(t,e){let r=new Fe.default(t,require.main);return r.filename=t,r.paths=Fe.default._nodeModulePaths(lt.default.dirname(t)),e&&r._compile(e,t),r}function Or(t,e){let r=Lr(t,e);r&&qr(r)}function qr(t,e=new Map){let r=require.cache[t];r&&(e.set(t,!0),r.children.forEach(o=>{e.get(o.id)||qr(o.id,e)}),delete require.cache[t])}async function je(t,e){let r=Xo(e.fileName),o=Si(r);function s(u){return e.require&&e.require[u]?e.require[u]:o.require(u)}let n=Sr.default.createContext(x(q(x({},global),{Buffer,process,requireUncached:u=>{c.warn("requireUncached is deprecated. It can no longer be supported due to esm conversion.");let p=f.dirname(r);return p&&Or(u,Xo(p)),o.require(u)}}),Oi(e.context))),i=Object.keys(n);Sr.default.runInContext(Fe.default.wrap(`${es.EOL}${t}`),n,{filename:r,lineOffset:e.lineOffset,displayErrors:!0}).apply(n,[o.exports,s,o,r,lt.default.dirname(r)]),Li(i,n,e.deleteVariable);let l=o.exports;if(Ae(l))l=await l;else for(let[u,p]of Object.entries(l))Ae(p)&&(l[u]=await p);return l}function Xo(t){return f.fsPath(t)||f.toString(t)}function Li(t,e,r){if(r)for(let o of t)typeof e[o]>"u"&&r(o)}async function Q(t,e){let r=`exports.$result = (${t});`,o=e.httpRegion.symbol.startLine;if(e.httpRegion.symbol.source){let n=be(e.httpRegion.symbol.source).findIndex(i=>i.indexOf(t)>=0);n>=0&&(o+=n)}return(await je(r,{fileName:e.httpFile.fileName,context:x({httpFile:e.httpFile,httpRegion:e.httpRegion,console:e.scriptConsole},e.variables),lineOffset:o})).$result}function Oi(t){let e={};for(let[r,o]of Object.entries(t))if(ts.indexOf(r)<0&&typeof o<"u"){let s=r.trim().replace(/\s/gu,"-").replace(/-./gu,n=>n[1].toUpperCase());e[s]=o}return e}var ts=["await","break","case","catch","class","const","continue","debugger","default","delete","do","else","enum","export","extends","false","finally","for","function","if","implements","import","in","instanceof","interface","let","new","null","package","private","protected","public","return","super","switch","static","this","throw","try","true","typeof","var","void","while","with","yield"];async function Tr(t){var r;let e=await qi(t);return e||(e=(r=await ut(f.joinPath(t,"package.json")))==null?void 0:r.httpyac),e&&await rs(e,t),e}var Et=[".httpyac.js",".httpyac.config.js","httpyac.config.js",".httpyac.json","httpyac.config.json"];async function qi(t){let e;for(let r of Et){let o=r&&f.joinPath(t,r);if(o&&await f.exists(o)){e=f.fsPath(o);break}}if(e){let r=f.fsPath(t);if(r){let o=Tt(e,r,!0);return typeof o=="function"?o():o}}}async function ut(t){try{let e=await f.readFile(t,"utf-8");return JSON.parse(e)}catch{c.debug(`json parse of ${t} failed`)}}async function rs(t,e){if(t.clientCertificates)for(let[,r]of Object.entries(t.clientCertificates))r.cert&&(r.cert=await M(r.cert,e)||r.cert),r.key&&(r.key=await M(r.key,e)||r.key),r.pfx&&(r.pfx=await M(r.pfx,e)||r.pfx)}async function Er(t){let e=await Ti(t),r={};if(e==null?void 0:e.json){let o=[...Object.keys(e.json.dependencies||{}),...Object.keys(e.json.devDependencies||{})].filter(Ei);for(let s of o){let n=f.fsPath(e.dir);if(n){let i=Tt(s,n);i&&(r[s]=i)}}}return r}async function Ti(t){let e=await Lt(t,"package.json");if(e)return{dir:e,json:await ut(f.joinPath(e,"package.json"))}}function Ei(t){return/^(httpyac-|@[\w-]+(\.)?[\w-]+\/httpyac-)plugin-/u.test(t)}var os="__NONE__";function U(t){return t&&t.length>0?t.sort().join(","):os}function $r(t){if(!t)return!1;if(t instanceof Error)return!0;let e=t;return!!e.message&&!!e.stack&&!!e.name}function Ir(t){var e;if(t.stack){let r=/^(?<error>.*):\s*(?<message>.*)\r?\n\s*at (?<file>.*):(?<line>\d*):(?<offset>\d*)/mu.exec(t.stack);if(r&&((e=r.groups)==null?void 0:e.error))return{error:t,errorType:r.groups.error,message:r.groups.message,file:r.groups.file,line:r.groups.line,offset:r.groups.offset,displayMessage:`${r.groups.error}: ${r.groups.message} - ${r.groups.file}:${r.groups.line}:${r.groups.offset}`}}return{error:t,displayMessage:t.message}}var ss=S(require("filesize")),pt=S(require("got")),ns=require("http-proxy-agent"),is=require("https-proxy-agent"),as=S(require("lodash/merge")),ls=require("socks-proxy-agent");function us(t){return async function(o,s){try{let n={decompress:!0,retry:0,throwHttpErrors:!1,headers:{accept:"*/*","user-agent":"httpyac"}},i=o.url;if(!i)throw new Error("empty url");let a=(0,as.default)({},n,t,o);delete a.url,Ai(a);let l=e(a);c.debug("request",l);let u;if(s.repeat&&s.repeat.count>0?u=await $i(i,l,s):u=await Ii(i,l,s),u)return u;throw new Error("no response")}catch(n){if(n instanceof pt.CancelError)return!1;throw n}};function e(r){let o={};return Object.assign(o,r),o}}async function $i(t,e,r){var i,a;let o=async()=>ps(await(0,pt.default)(t,e)),s=[];for(let l=0;l<(((i=r.repeat)==null?void 0:i.count)||1);l++)s.push(o);if(((a=r.repeat)==null?void 0:a.type)===1)return(await Promise.all(s.map(u=>u()))).pop();let n=[];for(let l of s)n.push(await l());return n.pop()}async function Ii(t,e,r){let o=(0,pt.default)(t,e),s=0;r.showProgressBar&&o.on("downloadProgress",a=>{var u;let l=a.percent-s;s=a.percent,((u=r.progress)==null?void 0:u.report)&&(c.debug("call http request"),r.progress.report({message:"call http request",increment:l*100}))});let n=r.progress&&r.progress.register(()=>{o.cancel()}),i=await o;return n&&n(),ps(i)}function Ai(t){if(t.proxy){if(t.proxy.startsWith("socks://")){let e=new ls.SocksProxyAgent(t.proxy);t.agent={http:e,https:e}}else t.agent={http:new ns.HttpProxyAgent(t.proxy),https:new is.HttpsProxyAgent(t.proxy)};delete t.proxy}}function ps(t){let e={statusCode:t.statusCode,protocol:`HTTP/${t.httpVersion}`,statusMessage:t.statusMessage,body:t.body,rawHeaders:t.rawHeaders,rawBody:t.rawBody,headers:t.headers,timings:t.timings.phases,httpVersion:t.httpVersion,request:{method:t.request.options.method,url:`${t.request.options.url}`,headers:t.request.options.headers,body:Fi(t.request.options.body)},contentType:Le(t.headers),meta:{ip:t.ip,redirectUrls:t.redirectUrls,size:(0,ss.default)(t.rawHeaders.map(r=>r.length).reduce((r,o)=>r+o,0)+t.rawBody.length)}};return delete t.headers[":status"],e.httpVersion&&e.httpVersion.startsWith("HTTP/")&&(e.httpVersion=e.httpVersion.slice(5)),e}function Fi(t){if(typeof t=="string"||Buffer.isBuffer(t))return t}function Ar(t){var r,o;let e=q(x({},((r=t.config)==null?void 0:r.request)||{}),{proxy:(o=t.config)==null?void 0:o.proxy});return us(e)}function ji(t){let e={};for(let r=0;r<t.length;r+=2){let o=t[r],s=t[r+1];if(typeof s>"u")continue;let n=o.toLowerCase();e[n]||(e[n]=[]),e[n].push(s)}return e}function h(t,e){var r,o;c.debug(e),(o=(r=t.progress)==null?void 0:r.report)==null||o.call(r,{message:e})}var Fr=require("hookpoint");function dt(t,e="global"){var r,o,s,n;if(t){if(t.metaData.title)return t.metaData.title;if(t.metaData.name)return t.metaData.name;if((r=t.request)==null?void 0:r.url){let i=t.request.url.indexOf("?");i<0&&(i=t.request.url.length);let a=((n=(s=(o=t.symbol.children)==null?void 0:o.find)==null?void 0:s.call(o,l=>l.kind==="requestLine"))==null?void 0:n.startLine)||t.symbol.startLine;return`${t.request.method} ${t.request.url.slice(0,i)} (line: ${a+1})`}}return e}function jr(t,e="-"){var r;return t.metaData.description?t.metaData.description:((r=t.request)==null?void 0:r.url)?`${t.request.method} ${t.request.url}`:e}async function ve(t,e){var o,s,n,i;delete t.httpRegion.response,delete t.httpRegion.testResults;let r=t.variables;try{(s=(o=t.scriptConsole)==null?void 0:o.collectMessages)==null||s.call(o),t.progress&&(t.showProgressBar=e),h(t,`${t.httpRegion.symbol.name}`),t.variables=Di(t);let a=t.httpRegion.hooks.execute;De(t.httpRegion)||(a=t.httpFile.hooks.execute.merge(a));let l=await a.trigger(t),u=ds(t);return u.response=await G(u==null?void 0:u.response,t),t.processedHttpRegions&&!De(t.httpRegion)&&t.processedHttpRegions.push(u),delete t.httpRegion.response,l!==Fr.HookCancel&&l.every(p=>!!p)}finally{t.httpRegion.metaData.noLog||(i=(n=t.scriptConsole)==null?void 0:n.flush)==null||i.call(n);let a=t.variables;t.variables=r,Mi(a,t)}}function Di(t){var s,n;let e=U(t.httpFile.activeEnvironment),r=t.httpFile.httpRegions;((s=t.config)==null?void 0:s.useRegionScopedVariables)&&(r=t.httpFile.httpRegions.filter(i=>De(i)));let o=Object.assign({},t.variables,...r.map(i=>i.variablesPerEnv[e]));return((n=t.config)==null?void 0:n.useRegionScopedVariables)?Object.assign(o,...t.httpFile.httpRegions.filter(i=>De(i)).map(i=>i.variablesPerEnv[e])):Object.assign(o,...t.httpFile.httpRegions.map(i=>i.variablesPerEnv[e])),o}function Mi(t,e){for(let[r,o]of Object.entries(t))e.variables[r]||(e.variables[r]=o)}async function G(t,e){if(t){let r=it(t);return await e.httpRegion.hooks.responseLogging.merge(e.httpFile.hooks.responseLogging).trigger(r,e)===Fr.HookCancel?void 0:(!e.httpRegion.metaData.noLog&&r&&e.logResponse&&await e.logResponse(r,e.httpRegion),r)}return t}async function Me(t){for(let e of t.httpFile.httpRegions)if(De(e)&&!e.metaData.disabled&&!await ve(q(x({},t),{httpRegion:e})))return!1;return!0}function ds(t){return{metaData:t.httpRegion.metaData&&x({},t.httpRegion.metaData),symbol:t.httpRegion.symbol,testResults:t.httpRegion.testResults,request:t.httpRegion.request&&x({},t.httpRegion.request),response:t.httpRegion.response&&it(t.httpRegion.response)}}function De(t){return!(t.request||t.metaData.name)}function Dr(t){let e=t;return!!(e==null?void 0:e.httpRegion)}function Mr(t){let e=t;return Array.isArray(e==null?void 0:e.httpRegions)}function Vi(t){let e=t;return!!e.httpRegion&&!!e.variables&&!!e.options}function Bi(t,e){let r=[];return t.request&&(r.push(...ms(t.request,{body:!!(e==null?void 0:e.requestBody)})),r.push("")),r.push(...cs(t,{prettyPrint:!!(e==null?void 0:e.prettyPrint),body:!!(e==null?void 0:e.responseBody)})),F(r)}function cs(t,e){let r=[];return r.push(`${t.protocol} ${t.statusCode} ${t.statusMessage?` - ${t.statusMessage}`:""}`),t.headers&&r.push(...Vr(t.headers)),(e==null?void 0:e.body)&&m(t.body)&&(r.push(""),r.push((e==null?void 0:e.prettyPrint)&&t.prettyPrintBody?t.prettyPrintBody:t.body)),r}function ms(t,e){let r=[];return r.push(`${t.method} ${t.url}`),t.headers&&r.push(...Vr(t.headers)),(e==null?void 0:e.body)&&m(t.body)&&(r.push(""),r.push(t.body)),r}function Vr(t){return Object.entries(t).map(([e,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):m(r)||(o=JSON.stringify(r))),`${e}: ${o}`})}var fs=require("os");function _i(t,e){let r=[];return t.request&&(r.push(...ys(t.request,{body:!!(e==null?void 0:e.requestBody)})),r.push("")),r.push(...gs(t,{prettyPrint:!!(e==null?void 0:e.prettyPrint),body:!!(e==null?void 0:e.responseBody)})),(e==null?void 0:e.testResults)&&(r.push(""),r.push(""),r.push(...bs(e.testResults))),(e==null?void 0:e.timings)&&t.timings&&(r.push(""),r.push(""),r.push(...xs(t.timings))),(e==null?void 0:e.meta)&&t.meta&&(r.push(""),r.push(""),r.push(...vs(t.meta))),$t(r)}function gs(t,e){let r=[];if(r.push(`\`${t.protocol} ${t.statusCode}${t.statusMessage?` - ${t.statusMessage}`:""}\``),t.headers&&r.push(...Br(t.headers)),(e==null?void 0:e.body)&&m(t.body)){r.push(""),r.push(`\`\`\`${hs(t.contentType)}`);let o=e.prettyPrint&&t.prettyPrintBody?t.prettyPrintBody:t.body;r.push($t(be(o))),r.push("```")}return r}function hs(t){return Xe(t)?"json":et(t)?"xml":nr(t)?"html":sr(t)?"js":ir(t)?"css":tt(t)?"markdown":""}function ys(t,e){let r=[];return r.push(`\`${t.method} ${t.url}\``),t.headers&&r.push(...Br(t.headers)),(e==null?void 0:e.body)&&m(t.body)&&(r.push(""),r.push("```json"),r.push($t(be(t.body))),r.push("```")),r}function bs(t){let e=[];e.push("`TestResults`"),e.push("");for(let r of t){let o=`${r.result?le.ok:le.error}: ${r.message}`;r.error&&(o+=` (${r.error.displayMessage})`),e.push(o)}return e}function Br(t){return Object.entries(t).map(([e,r])=>{let o=r||"";return r&&(Array.isArray(r)?o=r.join(", "):m(r)||(o=JSON.stringify(r))),`*${e}*: ${o}`}).sort()}function vs(t){let e=[];e.push("`Meta`"),e.push("");for(let[r,o]of Object.entries(t))Array.isArray(o)?o.length>0&&e.push(`*${r}*: ${o.join(",")}`):e.push(`*${r}*: ${o}`);return e}function xs(t){let e=[];return e.push("`Timings`"),e.push(""),t.wait&&e.push(`*Wait*: ${t.wait} ms`),t.dns&&e.push(`*DNS*: ${t.dns} ms`),t.tcp&&e.push(`*TCP*: ${t.tcp} ms`),t.tls&&e.push(`*TLS*: ${t.tls} ms`),t.request&&e.push(`*Request*: ${t.request} ms`),t.firstByte&&e.push(`*First Byte*: ${t.firstByte} ms`),t.download&&e.push(`*Download*: ${t.download} ms`),t.total&&e.push(`*Total*: ${t.total} ms`),e}function $t(t){return t.join(`  ${fs.EOL}`)}var _r=S(require("chalk"));function ct({httpRegion:t,scriptConsole:e}){let r=function(s,n){var a,l;let i={message:s,result:!0};if(t.testResults||(t.testResults=[]),typeof n=="function")try{n()}catch(u){process.exitCode=20,i.result=!1,$r(u)?i.error=Ir(u):i.error={displayMessage:`${u}`,error:new Error(`${u}`)}}t.testResults.push(i),(l=e==null?void 0:e.logTest)==null||l.call(e,i.result,i.result?_r.default`{green ${le.ok} ${i.message||"Test passed"}}`:_r.default`{red ${le.error} ${i.message||"Test failed"} (${(a=i.error)==null?void 0:a.displayMessage})}`)};return r.status=o=>{if(t.response){let s=t.response;r(`response status equals to ${o}`,()=>yr(s,o))}},r.totalTime=o=>{if(t.response){let s=t.response;r(`total time exceeded ${o}`,()=>br(s,o))}},r.header=(o,s)=>{if(t.response){let n=t.response;r(`response header equals ${s}`,()=>vr(n,o,s))}},r.headerContains=(o,s)=>{if(t.response){let n=t.response;r(`response header contains ${s}`,()=>xr(n,o,s))}},r.responseBody=o=>{if(t.response){let s=t.response;r(`response body equals ${o}`,()=>kr(s,o))}},r.hasResponseBody=()=>{if(t.response){let o=t.response;r("response body exists",()=>wr(o))}},r.hasNoResponseBody=()=>{if(t.response){let o=t.response;r("response body does not exists",()=>Rr(o))}},r}var ws=require("hookpoint");async function de(t,e,r){var o,s;return((s=(o=r.progress)==null?void 0:o.isCanceled)==null?void 0:s.call(o))?(c.trace("process canceled by user"),ws.HookCancel):await r.httpFile.hooks.replaceVariable.trigger(t,e,r)}async function ne(t,e,r){var s,n,i,a;let o=await de(t,"FilePath",e);if(m(o)){let l=await M(o,f.dirname(e.httpFile.fileName));if(l)return await r(l);let u=`file not found: ${t}`;(n=(s=O).showWarnMessage)==null||n.call(s,u),c.warn(u)}else{let l=`file replace made file invalid: ${t} <> ${o}`;(a=(i=O).showWarnMessage)==null||a.call(i,l),c.warn(l)}}function It(t,e){if(t&&m(t)){let r=t,o,s=/\{{2}([a-zA-Z0-9_]+)\}{2}/gu;for(;(o=s.exec(r))!==null;){let[n,i]=o,a=It(e[i],e);e[i]=a,r=r.replace(n,`${a}`)}return r}return t}function V(t,e){Object.assign(e.variables,t);let r=U(e.httpFile.activeEnvironment);e.httpRegion.variablesPerEnv[r]||(e.httpRegion.variablesPerEnv[r]={}),Object.assign(e.httpRegion.variablesPerEnv[r],t)}function mt(t,e){delete e.variables[t];let r=U(e.httpFile.activeEnvironment);e.httpRegion.variablesPerEnv[r]&&delete e.httpRegion.variablesPerEnv[r][t]}function qe(t,e){let r=U(e.httpFile.activeEnvironment),o=e.httpRegion.variablesPerEnv[r];for(let s of Object.keys(t))delete e.variables[s],o&&delete o[s]}var Ve={};var Ps=S(require("chalk")),Nr=require("hookpoint"),Cs=S(require("lodash/merge")),Be=class{constructor(){this.storeCache=[]}getFromStore(e,r){let o=f.toString(e),s=this.storeCache.find(n=>n.cacheKey===o);return s||(s={cacheKey:o,version:r},this.storeCache.push(s)),s}get(e){var o;let r=f.toString(e);return(o=this.storeCache.find(s=>s.cacheKey===r))==null?void 0:o.httpFile}getAll(){let e=[];for(let r of this.storeCache)r.httpFile&&e.push(r.httpFile);return e}getOrCreate(e,r,o,s){let n=this.getFromStore(e,o);return o>n.version||!n.httpFile?(n.promise&&o<=n.version||(n.promise=r().then(i=>this.parse(e,i,s)).then(i=>{if(delete n.promise,n.httpFile){for(let a of i.httpRegions){let l=n.httpFile.httpRegions.find(u=>u.symbol.source===a.symbol.source);l&&(a.variablesPerEnv=l.variablesPerEnv)}i.activeEnvironment=n.httpFile.activeEnvironment}return n.version=o,n.httpFile=i,i}).catch(i=>{throw delete n.promise,n.httpFile&&this.remove(n.httpFile.fileName),i})),n.promise):n.promise||Promise.resolve(n.httpFile)}async parse(e,r,o){let s=await this.initHttpFile(e,o);return await Ui(s,r,this)}remove(e){let r=f.toString(e),o=this.storeCache.findIndex(s=>s.cacheKey===r);o>=0&&this.storeCache.splice(o,1)}rename(e,r){let o=f.toString(e),s=this.storeCache.find(n=>n.cacheKey===o);s&&(s.cacheKey=f.toString(r),s.httpFile&&(s.httpFile.fileName=r))}clear(){this.storeCache.length=0}async initHttpFile(e,r){var l,u;let o=await M(e,r.workingDir)||e,s=await Cr(o,r.workingDir,"package.json",...Et,((l=r.config)==null?void 0:l.envDirName)||"env"),n={fileName:o,rootDir:s,hooks:{parse:new xt,parseEndRegion:new wt,replaceVariable:new Pt,provideEnvironments:new kt,provideVariables:new Rt,execute:new He,onStreaming:new Pe,onRequest:new Re,onResponse:new ke,responseLogging:new Ce},httpRegions:[],activeEnvironment:r.activeEnvironment};r.config=await ft(r.config,n.rootDir);let i=x({},Ve);s&&(Object.assign(i,await Er(s)),((u=r.config)==null?void 0:u.configureHooks)&&(i[".httpyac.js"]=r.config.configureHooks));let a=process.env.HTTPYAC_PLUGIN;if(a)try{let p=require(a);p.configureHooks&&(i.HTTPYAC_PLUGIN=p.configureHooks)}catch(p){c.warn("Global Hook Plugin not loaded",p)}return await this.configureHooks(n,r,i),n}async configureHooks(e,r,o){if(r.config){let s={version:"1.0.0",rootDir:e.rootDir,config:r.config,httpFile:e,hooks:e.hooks,log:c,fileProvider:f,sessionStore:E,userInteractionProvider:O,utils:v,getHookCancel:()=>Nr.HookCancel};for(let[n,i]of Object.entries(o))try{c.trace(`load ${n}`);let a=i(s);Ae(a)&&await a}catch(a){c.error(`error in ${n}`,a)}}}};async function ft(t,e){let r=[];if(e){let s=await Tr(e);s&&r.push(s)}t&&r.push(t);let o=(0,Cs.default)({log:{level:5,supportAnsiColors:!0},cookieJarEnabled:!0,envDirName:"env"},...r);return Ni(o),o}function Ni(t){var e,r,o;typeof((e=t==null?void 0:t.log)==null?void 0:e.level)>"u"?c.options.level=5:c.options.level=(r=t==null?void 0:t.log)==null?void 0:r.level,((o=t==null?void 0:t.log)==null?void 0:o.supportAnsiColors)===!1&&(Ps.default.level=0)}async function Ui(t,e,r){let o=be(e),s={lines:o,httpFile:t,httpRegion:ks(0),data:{},httpFileStore:r};for(let n=0;n<o.length;n++){let i=await t.hooks.parse.trigger(Ki(n,o),s);i&&i!==Nr.HookCancel&&(i.endRegionLine!==void 0&&i.endRegionLine>=0&&(s.httpRegion.symbol.endLine=i.endRegionLine,s.httpRegion.symbol.endOffset=o[i.endRegionLine].length,await Rs(s),s.httpRegion=ks(i.nextParserLine+1)),i.symbols&&(s.httpRegion.symbol.children?s.httpRegion.symbol.children.push(...i.symbols):s.httpRegion.symbol.children=i.symbols),n=i.nextParserLine)}return await Rs(s),s.httpRegion.symbol.endLine=o.length-1,s.httpRegion.symbol.endOffset=o[o.length-1].length,Gi(t.httpRegions,o),t}async function Rs(t){await t.httpFile.hooks.parseEndRegion.trigger(t);let{httpRegion:e}=t;t.httpRegion.symbol.name=dt(e),t.httpRegion.symbol.description=jr(e),t.httpFile.httpRegions.push(t.httpRegion)}function Gi(t,e){for(let r of t)Hs(r.symbol,e)}function Hs(t,e){t.source=F(e.slice(t.startLine,t.endLine+1));let r=t.endOffset-e[t.endLine].length;if(r>=0&&(r=void 0),t.source=t.source.slice(t.startOffset,r),t.children)for(let o of t.children)Hs(o,e)}function ks(t){return{metaData:{},symbol:{name:"-",description:"-",kind:"request",startLine:t,startOffset:0,endLine:t,endOffset:0},hooks:{execute:new He,onRequest:new Re,onStreaming:new Pe,onResponse:new ke,responseLogging:new Ce},variablesPerEnv:{}}}function Ki(t,e){return function*(o){for(let s=t;s<e.length;s++){let n=e[s];if(yield{textLine:n,line:s},!o&&/^\s*#{3,}(?<title>.*)$/u.test(n))break}}}var Ur=class{constructor(){this.userSessions=[];this.sessionChangedListener=[]}onSessionChanged(e){return this.sessionChangedListener.push(e),()=>{let r=this.sessionChangedListener.indexOf(e);r>=0&&this.sessionChangedListener.splice(r,1)}}async reset(){for(let e of this.userSessions)e.delete&&e.delete();this.userSessions.length=0,this.notifySessionChanged()}getUserSession(e){return this.userSessions.find(r=>r.id===e)}setUserSession(e){this.removeUserSession(e.id),this.userSessions.push(e),this.notifySessionChanged()}notifySessionChanged(){for(let e of this.sessionChangedListener)e()}removeUserSession(e){let r=this.userSessions.find(o=>o.id===e);r&&(r.delete&&r.delete(),this.userSessions.splice(this.userSessions.indexOf(r),1),this.notifySessionChanged())}isUserSession(e){let r=e;return r&&!!r.description&&!!r.id&&!!r.title&&!!r.type&&!!r.details}},E=new Ur;var gt=require("tough-cookie"),At=class{async beforeTrigger(e){let{request:r,httpFile:o,httpRegion:s,config:n,options:i}=e.args[0];if(W(r)&&!s.metaData.noCookieJar&&(n==null?void 0:n.cookieJarEnabled)){let a=this.getCookieStorePrefix(o),l=E.userSessions.filter(d=>d.type==="Cookie"&&d.id.startsWith(a)),u=new gt.MemoryCookieStore;for(let d of l)d.cookie&&u.putCookie(d.cookie,b=>{b&&c.info(b)});i.memoryStore=u;let p=new gt.CookieJar(u);if(r.headers&&r.url){let d=$(r.headers,"cookie");if(d){if(m(d))await p.setCookie(d,r.url);else if(Array.isArray(d))for(let b of d)await p.setCookie(b,r.url)}}r.cookieJar=p}return!0}async afterTrigger(e){let{httpFile:r,options:o}=e.args[0],s=o.memoryStore;if(s&&s instanceof gt.MemoryCookieStore){s.getAllCookies((i,a)=>{if(!i)for(let l of a){let u={id:`${this.getCookieStorePrefix(r)}_${l.toString()}`,title:`${l.domain} ${l.path} ${l.key}`,description:`${l}`,type:"Cookie",details:Object.fromEntries(Object.entries(l).map(([p,d])=>d?d instanceof Date?[p,d.toISOString()]:[p,d]:[]).filter(p=>p.length>0)),cookie:l};E.setUserSession(u)}});let n=E.userSessions.filter(i=>i.type==="Cookie");for(let i of n)i.cookie&&s.putCookie(i.cookie,a=>{a&&c.info(a)})}return!0}getCookieStorePrefix(e){var r,o;return`Cookies_${U(e.activeEnvironment)}_${((o=(r=e.rootDir)==null?void 0:r.toString)==null?void 0:o.call(r))||"none"}`}};var Ss=S(require("lodash/cloneDeep")),Ft=class{async beforeTrigger(e){let r=e.args[0];return r.httpRegion.request&&e.index===0&&(h(e.arg,"init request"),r.request=(0,Ss.default)(r.httpRegion.request)),!0}};var jt=class{constructor(e,r){this.data=e;this.setHeaders=r;this.id="defaultHeaders"}async process(e){if(this.data&&e.variables){h(e,"set request headers");let r=await Q(this.data,e);r&&this.setHeaders(Object.assign({},r),e)}return!0}};async function Kr(t,e){var r;if(t&&((r=e.config)==null?void 0:r.defaultHeaders)){h(e,"set default request headers");let o=e.config.defaultHeaders;if(!t.headers)t.headers=x({},o);else for(let[s,n]of Object.entries(o))t.headers[s]||(t.headers[s]=n)}}var Ls=S(require("eventsource")),Dt=class{constructor(){this.id="eventSourceClient"}async process(e){let{request:r}=e;return dr(r)?await se(async()=>r.url?(h(e,`request Server-Sent Events ${r.url}`),await this.requestEventSource(r,e)):!1,e):!1}async requestEventSource(e,r){var d,b;let{httpRegion:o}=r;if(!e.url)throw new Error("request url undefined");let s={};o.metaData.noRejectUnauthorized&&(s.rejectUnauthorized=!1);let n=Se(e.headers,"event")||["data"],i=x({},e.headers);fr(i,"event"),s.headers=i;let a={request:e},l={},u=[],p;try{let y=new Ls.default(e.url,s);r.progress&&(p=(b=(d=r.progress)==null?void 0:d.register)==null?void 0:b.call(d,()=>{y.close()})),y.addEventListener("open",k=>{c.debug("SSE open",k)});for(let k of n)y.addEventListener(k,H=>{c.debug(`SSE ${k}`,H),this.isMessageEvent(H)&&(l[H.type]||(l[H.type]=[]),l[H.type].push(H.data),r.httpRegion.metaData.noStreamingLog||(r.logStream?u.push(r.logStream("EventSource",H.type,H.data)):u.push(G(this.toHttpResponse(H,a),r))))});return y.addEventListener("error",k=>{c.debug("SSE error",k),l.error=[k]}),await r.httpFile.hooks.onStreaming.merge(r.httpRegion.hooks.onStreaming).trigger(r),await Promise.all(u),y.close(),this.toMergedHttpResponse(l,a)}finally{p&&p()}}isEventType(e){let r=e;return!!(r==null?void 0:r.type)}toMergedHttpResponse(e,r){let o=this.toHttpResponse(e,r);return e.error&&(o.statusCode=-1),o}toHttpResponse(e,r){let o=JSON.stringify(e,null,2),s=Buffer.from(o),n=q(x({headers:{},statusCode:0},r),{protocol:"SSE",body:o,prettyPrintBody:o,parsedBody:e,rawBody:s,contentType:{mimeType:"application/json",charset:"UTF-8",contentType:"application/json; charset=utf-8"}});return this.isEventType(e)&&e.type==="error"&&(n.statusCode=-1),n}isMessageEvent(e){let r=e;return!!r.type&&m(r.type)&&!!r.data}};var Mt=class{constructor(e){this.gqlData=e;this.id="gql";this.before=["httpClient"]}async process(e){var r,o,s,n,i;if(e.request&&((r=this.gqlData)==null?void 0:r.query)){h(e,"build GraphQL query");let a;if(m(this.gqlData.query))a=this.gqlData.query;else{let l=await this.gqlData.query(e);if(l)a=l;else{let u="query import not found";(s=(o=O).showWarnMessage)==null||s.call(o,u),c.warn(u)}}if(a){for(let[u,p]of Object.entries(this.gqlData.fragments))if(a.indexOf(`...${u}`)>=0){let d;if(m(p))d=p;else{let b=await p(e);if(b)d=b;else{let y=`query fragment ${u} not found`;(i=(n=O).showWarnMessage)==null||i.call(n,y),c.warn(y)}}d&&(a=F([a,d]))}let l={query:a};this.gqlData.operationName&&(l.operationName=this.gqlData.operationName),m(e.request.body)&&(l.variables=JSON.parse(e.request.body)),e.request.body=JSON.stringify(l)}}return!0}};var ie=S(require("@grpc/grpc-js")),_e=require("stream"),Wi=/^\s*((?<protocol>grpc|https?):\/\/)?(?<server>[^/]+?)(\/(?<path>.+))?\/(?<service>[^/]+?)\/(?<method>[^/]+?)$/iu,Vt=class{constructor(){this.id="grpcClient"}async process(e){ie.setLogger(c);let{request:r}=e,o=e.options.protoDefinitions;return mr(r)&&(r==null?void 0:r.url)&&o?await se(async()=>{var s,n;if(r.url){h(e,`request gRPC ${r.url}`);let i=this.getService(r.url,o);if(i.ServiceClass){let a=new i.ServiceClass(i.server,this.getChannelCredentials(r),this.getChannelOptions(r,i)),l=(n=(s=a[i.method])==null?void 0:s.bind)==null?void 0:n.call(s,a);if(l)return await this.requestGrpc(l,i.methodDefinition,r,e)}}return!1},e):!1}getChannelCredentials(e){if(e.headers){let r=$(e.headers,"channelcredentials");if(r instanceof ie.ChannelCredentials)return r}return ie.credentials.createInsecure()}getChannelOptions(e,r){let o={};return r.path&&(o.channelFactoryOverride=(s,n,i)=>{try{let a=Object.assign({},i);return delete a.channelFactoryOverride,a["grpc.default_authority"]=r.server,new Os(s,n,a,r.path)}catch(a){c.debug(a)}return new ie.Channel(s,n,i)}),Object.assign(o,e.options)}async requestGrpc(e,r,o,s){let n=this.getData(o),i=this.getMetaData(o),a=new Date().getTime();return await new Promise((l,u)=>{let p=[i],d,b={},y=[H=>H.on("metadata",T=>{b=T.getMap()}),H=>{s.progress&&(d=s.progress.register(()=>{H.destroy(new Error("Cancellation"))}))}],C=()=>({headers:b,request:o,timings:{total:new Date().getTime()-a}}),w=H=>{d&&d(),l(H)};(r==null?void 0:r.requestStream)?y.push(...this.getRequestStreamActions(n,s,u)):p.splice(0,0,n),(r==null?void 0:r.responseStream)?y.push(...this.getResponseStreamActions(r.path,w,C,s)):p.push((H,T)=>{w(this.toHttpResponse(H||T,C()))});let k=e(...p);y.forEach(H=>H(k))})}getRequestStreamActions(e,r,o){return[s=>{(e&&s instanceof _e.Writable||s instanceof _e.Duplex)&&s.write(e)},s=>{(s instanceof _e.Writable||s instanceof _e.Duplex)&&(V({grpcStream:s},r),r.httpFile.hooks.onStreaming.merge(r.httpRegion.hooks.onStreaming).trigger(r).then(()=>s.end()).catch(i=>o(i)))}]}getResponseStreamActions(e,r,o,s){let n=[],i=[],a=!1,l=u=>async()=>{if(c.debug(`GRPC ${u}`),!a){a=!0,qe({grpcStream:!0},s),await Promise.all(n);let p=this.toMergedHttpResponse(i,o());r(p)}};return[u=>u.on("data",p=>{c.debug("GRPC data",p),i.push(p),s.httpRegion.metaData.noStreamingLog||(s.logStream?n.push(s.logStream("gRPC",e,p)):n.push(G(this.toHttpResponse(p,o()),s)))}),u=>u.on("error",p=>{c.debug("GRPC error",p),i.push(p)}),u=>u.on("end",l("end")),u=>u.on("close",l("close"))]}getData(e){return m(e.body)?JSON.parse(e.body):Buffer.isBuffer(e.body)?JSON.parse(e.body.toString("utf-8")):e.body}getMetaData(e){let r=new ie.Metadata,o=["channelcredentials"];if(e.headers)for(let[s,n]of Object.entries(e.headers))o.indexOf(s.toLowerCase())<0&&(m(n)||Buffer.isBuffer(n))&&r.add(s,n);return r}getService(e,r){var s;let o=Wi.exec(e);if(o&&((s=o.groups)==null?void 0:s.service)){let{server:n,path:i,service:a,method:l,protocol:u}=o.groups,p=this.flattenProtoDefintions(r),d=p[a];if(!d){let y=Object.keys(p).find(C=>C.indexOf(a)>=0);y&&(c.warn(`service ${a} not found. Similar service ${y} is used.`),d=p[y])}if(typeof d=="function"){let y=d.service[l]||Object.entries(d.service).filter(([C])=>C.toLowerCase()===l.toLowerCase()).map(([,C])=>C).pop();return{server:n,service:a,path:i,protocol:u,method:l,ServiceClass:d,methodDefinition:y}}let b=Object.keys(p);throw b?(c.error(`Service ${a} does not exist. Available Services`,...b),new Error(`Service ${a} does not exist. Available Services: ${b.join(", ")}`)):(c.error(`Service ${a} does not exist. No Service imported`),new Error(`Service ${a} does not exist. No Service imported`))}else throw new Error(`Url ${e} does not match pattern <server>/<service>/<method>`)}flattenProtoDefintions(e){let r={};for(let o of Object.values(e))if(o.grpcObject){let s=this.getFlatGrpcObject(o.grpcObject);Object.assign(r,s)}return r}getFlatGrpcObject(e){return Object.entries(e).reduce((r,o)=>{if(typeof o[1]=="function")r[o[0]]=o[1];else if(this.isGrpcObject(o[1]))for(let[s,n]of Object.entries(this.getFlatGrpcObject(o[1])))r[`${o[0]}.${s}`]=n;return r},{})}isGrpcObject(e){let r=e;return r&&!r.format&&typeof e!="function"}toHttpResponse(e,r){let o=JSON.stringify(e,null,2),s=q(x({headers:{}},r),{statusCode:0,statusMessage:"OK",protocol:"GRPC",body:o,prettyPrintBody:o,parsedBody:e,rawBody:Buffer.from(o),contentType:{mimeType:"application/grpc+json",charset:"UTF-8",contentType:"application/grpc+json; charset=utf-8"}});return this.isGrpcError(e)&&(s.statusCode=e.code||-1,s.statusMessage=e.details),s}toMergedHttpResponse(e,r){let o=this.toHttpResponse(e,r),s=e.find(n=>this.isGrpcError(n));return this.isGrpcError(s)&&(o.statusCode=s.code||-1,o.statusMessage=s.details),o}isGrpcError(e){return e instanceof Error}},Os=class extends ie.Channel{constructor(e,r,o,s){super(e,r,o);this.path=s}createCall(e,r,o,s,n){return this.path?super.createCall(`/${this.path}${e}`,r,o,s,n):super.createCall(e,r,o,s,n)}};var Bt=class{constructor(){this.id="httpClient"}async process(e){let{httpRegion:r,httpClient:o,request:s}=e;return W(s)?(s.proxy=r.metaData.proxy,r.metaData.noRedirect&&(s.followRedirect=!r.metaData.noRedirect),r.metaData.noRejectUnauthorized&&(s.https=s.https||{},s.https.rejectUnauthorized=!1),h(e,`send ${s.method||"GET"} ${s.url}`),se(async()=>await o(s,e),e)):!1}};var Wr=S(require("lodash/cloneDeep")),qs=require("uuid"),Jr=(o=>(o[o.for=0]="for",o[o.forOf=1]="forOf",o[o.while=2]="while",o))(Jr||{}),_t=class{constructor(e){this.data=e;this.index=0;this.id=`loop_${(0,qs.v4)()}`}async beforeTrigger(e){var r;return((r=e.hookItem)==null?void 0:r.id)===this.id&&(this.index=e.index),!0}async process(e){this.iteration=this.iterate(e),this.name=e.httpRegion.metaData.name,h(e,"start loop");let r=await this.iteration.next();return r.done?!1:(e.request&&(this.request=(0,Wr.default)(e.request)),Object.assign(e.variables,r.value.variables),!0)}async afterTrigger(e){let r=e.args[0];if(this.iteration&&e.index+1===e.length){this.setResponsesList(r);let o=await this.iteration.next();o.done||(h(r,`${o.value.index} loop pass`),Object.assign(r.variables,o.value.variables),await G(r.httpRegion.response,r),r.httpRegion=this.createHttpRegionClone(r.httpRegion,o.value.index),this.request&&(r.request=(0,Wr.default)(this.request)),e.index=this.index)}else this.name&&r.variables[this.name]&&V({[`${this.name}0`]:r.variables[this.name],[`${this.name}0Response`]:r.variables.response},r);return!0}setResponsesList(e){let r=`${this.name}List`,o=e.variables[r];o||(o=[],V({[r]:o},e)),Array.isArray(o)&&hr(e.variables.response)&&o.push(nt(e.variables.response))}async*iterate(e){switch(this.data.type){case 1:if(this.data.variable&&this.data.iterable){let r=await Q(this.data.iterable,e),o;if(Array.isArray(r)&&(o=r),o){let s=0;for(let n of o){let i={$index:s};i[this.data.variable]=n,yield{index:s,variables:i},s++}}}break;case 0:if(this.data.counter)for(let r=0;r<this.data.counter;r++)yield{index:r,variables:{$index:r}};break;case 2:if(this.data.expression){let r=0;for(;await Q(this.data.expression,e);)yield{index:r,variables:{$index:r}},r++}break;default:break}}createHttpRegionClone(e,r){return{metaData:q(x({},e.metaData),{name:this.name?`${this.name}${r}`:void 0}),request:e.request?x({},e.request):void 0,symbol:e.symbol,hooks:{execute:new He,onRequest:new Re,onStreaming:new Pe,onResponse:new ke,responseLogging:new Ce},variablesPerEnv:e.variablesPerEnv}}};var Qr=class{constructor(e){this.context=e;this.userSession=this.getIntellijSession(e)}getIntellijSession(e){let r=U(e.httpFile.activeEnvironment),o=`intellij_global_cache_${r}`,s=E.getUserSession(o);if(this.isIntellijGlobalCacheSession(s))return s;let n={id:o,title:`Intellij Cache for ${r}`,description:`Intellij Cache for ${r}`,details:{},type:"intellij_global_cache",variables:{}};return E.setUserSession(n),n}isIntellijGlobalCacheSession(e){return!!(e==null?void 0:e.id)&&!!e.title}set(e,r){this.userSession.variables[e]=r,V({[e]:r},this.context)}get(e){return this.context.variables[e]}isEmpty(){return Object.entries(this.userSession.variables).length===0}clear(e){delete this.userSession.variables[e],mt(e,this.context)}clearAll(){for(let[e]of Object.entries(this.userSession.variables))this.clear(e)}};var Ts=require("assert"),zr=class{constructor(e){this.context=e;this.global=new Qr(e)}test(e,r){ct(this.context)(e,r)}assert(e,r){(0,Ts.ok)(e,r)}log(e){this.context.scriptConsole&&this.context.scriptConsole.info(e)}};var Yr=class{constructor(e){var r,o;this.body=e.parsedBody||e.body,this.status=e.statusCode,this.contentType={mimeType:((r=e.contentType)==null?void 0:r.mimeType)||"application/octet-stream",charset:((o=e.contentType)==null?void 0:o.charset)||"utf-8"},this.headers=new Es(e.headers)}},Es=class{constructor(e){this.headers=e}valueOf(e){if(this.headers){let r=this.headers[e];if(r&&m(r))return r}return null}valuesOf(e){if(this.headers){let r=this.headers[e];if(r&&Array.isArray(r))return r}return[]}};var Nt=class{constructor(e){this.scriptData=e;this.id="intellij"}async process(e){let r=Qi(e),o;if(this.isIntellijScriptData(this.scriptData)){let s=await this.loadScript(this.scriptData.fileName,e);if(!s)return!1;o={script:s,lineOffset:0}}else o=this.scriptData;return h(e,"execute intellij javascript"),await je(o.script,{fileName:e.httpFile.fileName,context:x({console:e.scriptConsole},r),lineOffset:o.lineOffset}),!0}async loadScript(e,r){var o,s;try{return await ne(e,r,n=>f.readFile(n,"utf-8"))}catch(n){return(s=(o=O).showErrorMessage)==null||s.call(o,`error loading script ${e}`),c.error(e,n),!1}}isIntellijScriptData(e){return!!e.fileName}};function Qi(t){let e;return t.httpRegion.response&&(e=new Yr(t.httpRegion.response)),{client:new zr(t),response:e}}var Ut=class{constructor(e,r){this.fileName=e;this.httpFileStore=r;this.id="import"}async process(e){let r=await ne(this.fileName,e,async o=>{c.trace(`parse imported file ${o}`);let s=await f.readFile(o,"utf-8"),n=await this.httpFileStore.getOrCreate(o,()=>Promise.resolve(s),0,{workingDir:e.httpFile.rootDir,config:e.config,activeEnvironment:e.httpFile.activeEnvironment});return e.options.httpFiles?e.options.httpFiles.push(n):e.options.httpFiles=[n],n});if(r){let o=q(x({},e),{httpFile:r});return c.trace(`execute global scripts for import ${r.fileName}`),await Me(o)}return!1}};var Zr=require("os"),Gt=class{constructor(e){this.rawBody=e}async beforeTrigger(e){let r=e.args[0];if(r.request&&e.index===0){let o=r.request.contentType,s=await this.normalizeBody(this.rawBody,r);if(s.length>0)if(h(e.arg,"init request body"),rt(o))r.request.body=this.formUrlEncodedJoin(s);else{s.every(l=>m(l))&&lr(o)&&s.push("");let n=[],i=[],a=ar(o)?`\r
`:Zr.EOL;for(let l of s)m(l)?i.push(l):(i.length>0&&(i.push(""),n.push(i.join(a)),i.length=0),n.push(l),i.push(""));i.length>0&&n.length===0?r.request.body=i.join(a):(i.length>0&&n.push(i.join(a)),r.request.body=n)}}return!0}async normalizeBody(e,r){let o=[],s=n=>{var i;if(r.httpRegion.metaData.injectVariables)return!0;if((i=r.config)==null?void 0:i.requestBodyInjectVariablesExtensions){let a=Pr(n);if(a)return r.config.requestBodyInjectVariablesExtensions.indexOf(a)>=0}return!1};for(let n of e)if(m(n))o.push(n);else{let i=await ne(n.fileName,r,async a=>s(n.fileName)||n.injectVariables?await f.readFile(a,n.encoding):()=>f.readBuffer(a));i&&o.push(i)}return o}formUrlEncodedJoin(e){let r=e.reduce((o,s,n)=>{let i=o;return m(s)&&(i+=`${n===0||s.startsWith("&")?"":Zr.EOL}${s}`),i},"");return m(r)?r:""}};async function Xr(t,e){let r=t.parsedBody||t.body;(e.httpRegion.metaData.name||e.httpRegion.metaData.jwt)&&(Zi(r,e),Yi(t,r,e)),zi(e,t)}function zi(t,e){let r=nt(e);E.setUserSession({id:"last_response",title:"last response",description:`response of ${t.httpRegion.symbol.name}`,details:{},type:"LAST_RESPONSE",response:r}),t.variables.response=e}function Yi(t,e,r){let{httpRegion:o}=r;if(o.metaData.name){let s=o.metaData.name.trim().replace(/\s/gu,"-").replace(/-./gu,n=>n[1].toUpperCase());V({[s]:e,[`${s}Response`]:t},r)}}function Zi(t,{httpRegion:e}){if(e.metaData.jwt&&e.response&&t&&typeof t=="object"){let r=Object.entries(t),o=r;if(m(e.metaData.jwt)){let s=e.metaData.jwt;o=r.filter(([n])=>s.indexOf(n)>=0)}for(let[s,n]of o){let i=Xi(n);i&&r.push([`${s}_parsed`,i])}e.response.parsedBody=Object.fromEntries(r),e.response.prettyPrintBody=JSON.stringify(e.response.parsedBody,null,2),e.response.body=e.response.prettyPrintBody}}function Xi(t){return m(t)?Oe(t):null}var Kt=class{constructor(e){this.data=e;this.id="ref"}async process(e){h(e,`load reference ${this.data.name}`);for(let r of e.httpFile.httpRegions)if(r.metaData.name===this.data.name&&!r.metaData.disabled&&r!==e.httpRegion){let o=U(e.httpFile.activeEnvironment);if(c.trace("import variables",r.variablesPerEnv[o]),Object.assign(e.variables,r.variablesPerEnv[o]),this.data.force||!e.variables[this.data.name]){let s=q(x({},e),{httpRegion:r});await ve(s)}return!0}if(e.options.httpFiles)for(let r of e.options.httpFiles){let o=q(x({},e),{options:x({},e.options),httpFile:r});delete o.options.httpFiles,await this.process(o)}return!0}};async function eo(t,{variables:e,httpRegion:r}){await ea(t,e),await ta(r,e)}async function ea(t,e){if(t&&e&&typeof e.request_rejectUnauthorized<"u"){let r=ra(e.request_rejectUnauthorized);st(t)?t.options=Object.assign({},t.options,{rejectUnauthorized:r}):W(t)&&(t.https=Object.assign({},t.https,{rejectUnauthorized:r}))}}async function ta(t,e){t&&m(e==null?void 0:e.request_proxy)&&(t.metaData.proxy=e.request_proxy)}function ra(t){return m(t)?["0","false","no"].indexOf(t.toLowerCase())<0:typeof t=="boolean"?t:!!t}var ge=require("hookpoint");async function to(t,e){if(h(e,"replace variables in request"),t.url){let r=await de(t.url,"Url",e)||t.url;if(r===ge.HookCancel)return ge.HookCancel;m(r)&&(t.url=r)}if(await oa(t,e)===!1)return ge.HookCancel;if(await sa(t,e)===!1)return ge.HookCancel}async function oa(t,e){if(t.body){if(m(t.body)){let r=await de(t.body,"Body",e);if(r===ge.HookCancel)return!1;(m(r)||Buffer.isBuffer(r))&&(t.body=r)}else if(Array.isArray(t.body)){let r=[];for(let o of t.body)if(m(o)){let s=await de(o,"Body",e);if(s===ge.HookCancel)return!1;m(s)&&r.push(s)}else r.push(o);t.body=r}}return!0}async function sa(t,e){if(t.headers)for(let[r,o]of Object.entries(t.headers))if(Array.isArray(o)){let s=[];for(let n of o){let i=await de(n,r,e);if(i===ge.HookCancel)return!1;s.push(i)}t.headers[r]=s}else{let s=await de(o,r,e);if(s===ge.HookCancel)return!1;t.headers[r]=s}return!0}var $s=S(require("encodeurl"));async function ro(t){t.body&&(m(t.body)?rt(t.contentType)&&(t.body=(0,$s.default)(t.body)):Array.isArray(t.body)&&t.body.some(e=>typeof e=="function")&&t.body.every(e=>["function","string"].indexOf(typeof e)>=0)&&(t.body=await na(t.body)))}async function na(t){let e=[];for(let r of t)m(r)?e.push(Buffer.from(r)):e.push(await r());return Buffer.concat(e)}var Is=S(require("ws")),ia=1e3,aa=1001,Wt=class{constructor(){this.id="websocketClient"}async process(e){let{request:r}=e;return st(r)?await se(async()=>r.url?(h(e,`request websocket ${r.url}`),await this.requestWebsocket(r,e)):!1,e):!1}async requestWebsocket(e,r){let{httpRegion:o}=r,s=new Date().getTime();return await new Promise((n,i)=>{var k,H;if(!e.url){i(new Error("request url undefined"));return}let a=Object.assign({},e.options);o.metaData.noRedirect&&(a.followRedirects=!o.metaData.noRedirect),o.metaData.noRejectUnauthorized&&(a.rejectUnauthorized=!1),a.headers=e.headers;let l={request:e},u=[],p=[],d=()=>(l.timings={total:new Date().getTime()-s},l),b=new Is.default(e.url,a),y={websocketClient:b},C;r.progress&&(C=(H=(k=r.progress)==null?void 0:k.register)==null?void 0:H.call(k,()=>{b.close(aa,"CLOSE_GOING_AWAY")})),b.on("open",()=>{c.debug("WebSocket open"),e.body&&b.send(e.body,R=>c.error(R)),V(y,r),r.variables.websocketClient=b,r.httpFile.hooks.onStreaming.merge(r.httpRegion.hooks.onStreaming).trigger(r).then(()=>b.close(ia,"CLOSE_NORMAL")).catch(R=>i(R))}),b.on("upgrade",T=>{c.debug("WebSocket upgrade",T),l.headers=T.headers,l.statusCode=T.statusCode,l.statusMessage=T.statusMessage,l.httpVersion=T.httpVersion});let w=T=>R=>{let I=this.toStringBody(R);c.debug(`WebSocket ${T}`,I),u.push({type:T,body:I}),r.httpRegion.metaData.noStreamingLog||(r.logStream?p.push(r.logStream("WebSocket",T,I)):p.push(G(this.toHttpResponse(I,d()),r)))};b.on("ping",w("ping")),b.on("pong",w("pong")),b.on("message",w("message")),b.on("error",T=>{c.debug("WebSocket error",T),u.push(T)}),b.on("close",async(T,R)=>{c.debug("WebSocket close",T,R),C&&C(),qe(y,r),await Promise.all(p),n(this.toMergedHttpResponse(T,R,u,d()))})})}toMergedHttpResponse(e,r,o,s){let n=this.toHttpResponse(o,s);return n.statusCode=e,n.statusMessage=Buffer.isBuffer(r)?r.toString("utf-8"):r,n}toStringBody(e){if(Buffer.isBuffer(e))return e.toString("utf-8");let r=e;return Array.isArray(e)&&e.every(o=>Buffer.isBuffer(o))&&(r=e.map(o=>Buffer.isBuffer(o)&&o.toString("utf8"))),JSON.stringify(r,null,2)}toHttpResponse(e,r){let o=m(e)?e:JSON.stringify(e,null,2),s=Buffer.from(o),n=q(x({headers:{},statusCode:200},r),{protocol:"WebSocket",body:o,prettyPrintBody:o,parsedBody:e,rawBody:s,contentType:{mimeType:"application/json",charset:"UTF-8",contentType:"application/json; charset=utf-8"}});return this.isWebsocketError(e)&&(n.statusCode=-1,n.statusMessage=e.code),n}isWebsocketError(e){return e instanceof Error}};var Yt={};ae(Yt,{AfterJavascriptHookInterceptor:()=>mo,AsciidocInterceptor:()=>Jt,CodeBlockInterceptor:()=>Ne,MarkdownInterceptor:()=>zt,ParserRegex:()=>g,ProtoDefinitionCreationInterceptor:()=>Ho,ProtoImportAction:()=>Co,closeRequestBody:()=>vo,closeResponseBody:()=>ko,injectNote:()=>go,knownMetaData:()=>Gs,parseComment:()=>so,parseComments:()=>Qt,parseEventSource:()=>ao,parseGraphql:()=>uo,parseGrpcLine:()=>lo,parseIntellijScript:()=>po,parseJavascript:()=>co,parseMetaData:()=>io,parseOutputRedirection:()=>yo,parseProtoImport:()=>Po,parseRequestBody:()=>bo,parseRequestLine:()=>xo,parseResponse:()=>Ro,parseResponseRef:()=>wo,parseVariable:()=>Lo,parseWebsocketLine:()=>Oo,registerCancelExecutionInterceptor:()=>oo});var g={auth:{aws:/^\s*(aws)\s+(?<accessKeyId>[^\s]*)\s+(?<secretAccessKey>[^\s]*)\s*(token:\s*(?<token>[^\s]*))?\s*(region:\s*(?<region>[^\s]*))?\s*(service:\s*(?<service>[^\s]*))?\s*$/iu,basic:/^\s*(basic)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,basicColon:/^\s*(basic)\s+(?<user>.*):(?<password>.*)$/iu,clientCert:/^\s*(cert:\s*(?<cert>[^\s]*)\s*)?(key:\s*(?<key>[^\s]*)\s*)?(pfx:\s*(?<pfx>[^\s]*)\s*)?(passphrase:\s*(?<passphrase>[^\s]*)\s*)?\s*$/u,digest:/^\s*(digest)\s+(?<user>[^\s]*)\s+(?<password>([^\s]+.*))$/iu,oauth2:/^\s*(?<type>openid|oauth2)(\s+(?<flow>client(_credentials)?|(authorization_)?code|device(_code)?|password|implicit|hybrid))?(\s+(?<variablePrefix>[^\s]*))?\s*((token_exchange)\s+(?<tokenExchangePrefix>[^\s]*))?\s*$/iu},comment:{multilineEnd:/^\s*\*\/\s*$/u,multilineStart:/^\s*\/\*$/u,singleline:/^\s*\/\/\s*(?<comment>.*)\s*$/u},emptyLine:/^\s*$/u,gql:{fileImport:/^\s*gql(\s+(?<name>[^\s(]+))?\s+<\s+(?<fileName>.+)\s*$/u,fragment:/^\s*(fragment)\s+(?<name>[^\s(]+)\s+on\s+/u,query:/^\s*(query|mutation)(\s+(?<name>[^\s(]+))?/u},grpc:{proto:/^\s*proto\s+<\s+(?<fileName>.+)\s*$/u,grpcLine:/^\s*(GRPC|grpc)\s*(?<url>.+?)\s*$/u,grpcProtocol:/^\s*grpc:\/\/(?<url>.+?)\s*$/u},stream:{websocketLine:/^\s*(ws|wss|websocket)\s*(?<url>.+?)\s*$/iu,websocketProtocol:/^\s*ws(s)?:\/\/(?<url>.+?)\s*$/iu,eventSourceLine:/^\s*(sse|eventsource)\s*(?<url>.+?)\s*$/iu},intellij:{import:/^\s*>\s+(?<fileName>[^\s{%}]+\s*)$/u,scriptEnd:/^\s*%\}\s*$/u,scriptSingleLine:/^\s*>\s+\{%\s*(?<script>.*)\s*%\}\s*$/u,scriptStart:/^\s*>\s+\{%\s*$/u},javascript:{scriptStart:/^\s*\{\{(@js\s+)?(?<modifier>\+|@)?(?<event>(request|streaming|response|after|responseLogging)?)?\s*$/iu,scriptEnd:/^\s*\}\}\s*$/u,scriptSingleLine:/\{{2}(.+?)\}{2}/gu},meta:{all:/^\s*(#+|\/{2})/u,comment:/^\s*((#\s+)|(\/{2}))/u,delimiter:/^\s*#{3,}(?<title>.*)$/u,data:/^\s*(#+|\/{2,})\s+@(?<key>[^\s]*)(\s+)?"?(?<value>.*)?"?$/u,forOf:/^\s*for\s+(?<variable>.*)\s+of\s+(?<iterable>.*)\s*/u,for:/^\s*for\s*(?<counter>\d*)\s*$/u,while:/^\s*while\s*(?<expression>.*)\s*$/u,rateLimit:/^\s*(slot(:)?\s*(?<slot>[^\s]+))?\s*(minIdleTime(:)?\s*(?<minIdleTime>\d*))?\s*(max(:)?\s*(?<max>\d*))\s*(expire(:)?\s*(?<expire>\d*))?\s*$/iu},request:{fileImport:/^<(?:(?<injectVariables>@)(?<encoding>\w+)?)?\s+(?<fileName>.+?)\s*$/u,header:/^\s*(?<key>[!#$%&'*+\-.^_`|~0-9A-Za-z]+)\s*:\s*(?<value>.*?),?\s*$/u,headersSpread:/^\s*\.{3}(?<variableName>[^\s]+),?\s*$/u,queryLine:/^\s*(\?|&)([^=\s]+)=(.*)$/u,requestLine:/^\s*(?<method>GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS|CONNECT|TRACE|PROPFIND|PROPPATCH|MKCOL|COPY|MOVE|LOCK|UNLOCK|CHECKOUT|CHECKIN|REPORT|MERGE|MKACTIVITY|MKWORKSPACE|VERSION-CONTROL|BASELINE-CONTROL)\s*(?<url>.+?)(\s+HTTP\/(?<version>(\S+)))?$/u,urlLine:/^\s*(\/).*$/u},outputRedirection:/^\s*>>(?<force>!)?\s+(?<fileName>[^\s{%}]+\s*)$/u,responseLine:/^\s*HTTP\/(?<httpVersion>\S+)\s*(?<statusCode>[1-5][0-9][0-9])\s*(-)?\s*(?<statusMessage>.*)$/u,responseRef:/^\s*<>\s*(?<fileName>.+?)\s*$/u,variable:/^\s*@(?<key>[^\s=]*)\s*(?<operator>=\s*)"?(?<value>.*)"?\s*$/u};var Ne=class{constructor(e,r,o){this.extensions=e;this.beginCodeBlock=r;this.endCodeBlock=o}async beforeTrigger(e){let r=e.args[0],o=e.args[1];if(f.hasExtension(o.httpFile.fileName,...this.extensions)){let s=this.getHttpBlockLines(o.lines,o.data);e.args[0]=function*(i){if(s.length>0){let a=r(!0);for(let l of a){let u=s.find(p=>p.startLine<=l.line&&l.line<p.endLine);if(u)if(u.startLine===l.line)yield{line:l.line,textLine:"###"};else{if(!i&&g.meta.delimiter.test(l.textLine))break;yield l}else break}}}}return!0}getHttpBlockLines(e,r){if(r==null?void 0:r.codeBlocks)return r.codeBlocks;let o=[],s=-1;for(let n=0;n<e.length;n++){let i=e[n];s<0?Array.isArray(this.beginCodeBlock)?e.length>n+this.beginCodeBlock.length&&this.beginCodeBlock.every((a,l)=>a.test(e[n+l]))&&(s=n+this.beginCodeBlock.length-1,n+=this.beginCodeBlock.length-1):this.beginCodeBlock.test(i)&&(s=n):this.endCodeBlock.test(i)&&(o.push({startLine:s,endLine:n}),s=-1)}return r.codeBlocks=o,o}};var Jt=class extends Ne{constructor(){super(["adoc","asciidoc","asc"],[/^\[source,http\]\s*$/iu,/^----\s*$/u],/^----\s*$/u)}};function oo(t){t.httpRegion.hooks.execute.addInterceptor({beforeLoop:async function(r){var s,n;return((n=(s=r.args[0].progress)==null?void 0:s.isCanceled)==null?void 0:n.call(s))?(c.trace("process canceled by user"),!1):!0}})}async function so(t,{httpRegion:e}){let r=t(!0),o=la(r);return o?(e.metaData.description||(e.metaData.description=o.comment),{nextParserLine:o.endLine,symbols:[{name:"comment",description:o.comment,kind:"comment",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset}]}):!1}function la(t){var r;let e=t.next();if(!e.done){let o=e.value.line,s=g.comment.singleline.exec(e.value.textLine);if((r=s==null?void 0:s.groups)==null?void 0:r.comment)return{startLine:o,endLine:o,endOffset:e.value.textLine.length,comment:s.groups.comment};if(g.comment.multilineStart.exec(e.value.textLine)){e=t.next();let i=[];for(;!e.done;){if(g.comment.multilineEnd.test(e.value.textLine))return{startLine:o,endLine:e.value.line,endOffset:e.value.textLine.length,comment:F(i)};i.push(e.value.textLine),e=t.next()}}}return!1}function As(t,e,r){return r.httpRegion.metaData=Object.assign(r.httpRegion.metaData||{},{[t]:e||!0}),!0}function Fs(t,e,r){return t==="import"&&e?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Ut(e,r.httpFileStore)),!0):!1}function js(t,e,r){return["ref","forceRef"].indexOf(t)>=0&&e?(r.httpRegion.hooks.execute.addObjHook(o=>o.process,new Kt({name:e,force:t==="forceRef"})),!0):!1}function Ds(t,e,r){var o,s,n,i;if(t==="loop"&&e){let a=g.meta.forOf.exec(e);if(((o=a==null?void 0:a.groups)==null?void 0:o.iterable)&&((s=a==null?void 0:a.groups)==null?void 0:s.variable))return no(r,{type:1,variable:a.groups.variable,iterable:a.groups.iterable}),!0;let l=g.meta.for.exec(e);if((n=l==null?void 0:l.groups)==null?void 0:n.counter)return no(r,{type:0,counter:Number.parseInt(l.groups.counter,10)}),!0;let u=g.meta.while.exec(e);if((i=u==null?void 0:u.groups)==null?void 0:i.expression)return no(r,{type:2,expression:u.groups.expression}),!0}return!1}function no(t,e){let r=new _t(e);t.httpRegion.hooks.execute.addObjHook(o=>o.process,r),t.httpRegion.hooks.execute.addInterceptor(r)}function Vs(t,e,r){return t==="keepStreaming"?(r.httpRegion.hooks.onStreaming.addHook("keepStreaming",async o=>{if(o.request){let s={id:Ms(o.request),type:"Stream",title:`${o.request.method} ${o.request.url}`,description:"Pending Stream",details:o.request.headers||{}};h(o,"stream until manual cancellation"),await new Promise(n=>{E.setUserSession(s),s.delete=()=>n(!0)})}}),r.httpRegion.hooks.onResponse.addHook("keepStreaming",(o,s)=>{s.request&&E.removeUserSession(Ms(s.request))}),!0):!1}function Ms(t){return`${t.method}_${t.url}_${Object.values(t.headers||{}).join("_")}`}function Bs(t,e,{httpRegion:r}){if(t==="ratelimit"&&e){let o=g.meta.rateLimit.exec(e);if(o==null?void 0:o.groups){let s=o.groups.slot||"rateLimit",n=o.groups.minIdleTime||"0",i=o.groups.max||"0",a=o.groups.expire||"0";r.hooks.execute.addHook("rateLimit",async l=>{let u=da(s,Number.parseInt(n,10),Number.parseInt(i,10),Number.parseInt(a,10));return u.requests.push(await ua(u,l)),!0})}}return!1}async function ua(t,e){for(;t.requests.length>0;){let r=new Date;if(ca(t.requests,r,t.expire),t.max>0&&t.requests.length>=t.max){let o=t.requests[0],s=t.expire+o.getTime()-r.getTime();s>0&&(h(e,`rate limit max reached. wait for ${s}`),c.debug(`rate limit max reached. wait for ${s} (slot ${t.slot})`),await pe(s),c.trace("rate limit max waited"));continue}if(t.requests.length>0){let o=t.requests[t.requests.length-1];if(o&&t.minIdleTime>0){let s=o.getTime()+t.minIdleTime-r.getTime();if(s>0){h(e,`rate limit minIdleTime, wait for ${s}`),c.debug(`rate limit minIdleTime, wait for ${s} (slot ${t.slot})`),await pe(s),c.trace("rate limit minIdleTime waited");continue}}}return r}return new Date}function pa(t){let e=t;return!!(e==null?void 0:e.requests)&&e.type==="RateLimit"}function da(t,e,r,o){let s=`ratelimit_${t}`,n=E.getUserSession(s);if(pa(n))return n.max=r,n.minIdleTime=e,n.expire=o,n;let i=[];e>0&&i.push(`minIdleTime ${e}ms`),o>0&&i.push(`max ${r} with expire ${o}ms`);let a={id:s,type:"RateLimit",title:`rate limit slot ${t}`,details:{slot:t,minIdleTime:e,max:r,expire:o},description:i.join(", "),slot:t,minIdleTime:e,max:r,expire:o,requests:[]};return E.setUserSession(a),a}function ca(t,e,r){if(r>0){let o=0;for(let s of t)if(e.getTime()-s.getTime()>=r)o++;else break;t.splice(0,o)}else t.splice(0,t.length-1)}function _s(t,e,r){return t==="responseRef"&&e&&(r.httpRegion.responseRefs||(r.httpRegion.responseRefs=[]),r.httpRegion.responseRefs.push(e)),!1}function Ns(t,e,r){return t==="sleep"&&e?(r.httpRegion.hooks.execute.addHook("sleep",async o=>{let s=await Q(e,o);return Number.isSafeInteger(s)&&await pe(s),!0}),!0):!1}function Us(t,e,r){if(t==="verbose"||t==="debug"){let o=t==="debug"?2:1;return c.options.level=o,r.httpRegion.hooks.execute.addInterceptor({async beforeLoop(){return c.options.level=o,!0}}),!0}return!1}async function io(t,e){var i,a;let r=t(),{httpRegion:o,data:s}=e;s.metaTitle&&(o.metaData.title=s.metaTitle.trim(),o.metaData.name||(o.metaData.name=s.metaTitle.trim()),delete s.metaTitle);let n=r.next();if(!n.done){let l=n.value.textLine;if(g.meta.all.test(l)){if(fa(e)&&l.trim()!=="###")return c.debug("request with markdown only supports delimiter after request line"),!1;let u={nextParserLine:n.value.line,symbols:[]},p=g.meta.delimiter.exec(l);if(p)u.endRegionLine=n.value.line-1,u.symbols.push({name:"separator",description:((i=p.groups)==null?void 0:i.title)||"-",kind:"metaData",startLine:n.value.line,startOffset:0,endLine:n.value.line,endOffset:l.length}),s.metaTitle=(a=p.groups)==null?void 0:a.title;else{let d=Qt(n.value,e,g.meta.all);d&&(u.symbols=d.symbols)}return u}}return!1}function Qt(t,e,r){var o;if(r.test(t.textLine)){let s={symbols:[{name:"comment",description:t.textLine,kind:"metaData",startLine:t.line,startOffset:0,endLine:t.line,endOffset:t.textLine.length}]},n=g.meta.data.exec(t.textLine);if(n&&n.groups&&n.groups.key){let i=n.groups.key.replace(/-./gu,l=>l[1].toUpperCase());s.symbols[0].children=[{name:i,description:n.groups.value||"-",kind:"metaData",startLine:t.line,startOffset:0,endLine:t.line,endOffset:t.textLine.length,children:[{name:i,description:((o=Gs.find(l=>l.name===i))==null?void 0:o.description)||"key of meta data",kind:"key",startLine:t.line,startOffset:t.textLine.indexOf(n.groups.key),endLine:t.line,endOffset:t.textLine.indexOf(n.groups.key)+n.groups.key.length}]}],n.groups.value&&s.symbols[0].children.push({name:n.groups.value,description:"value of meta data",kind:"value",startLine:t.line,startOffset:t.textLine.indexOf(n.groups.value),endLine:t.line,endOffset:t.textLine.indexOf(n.groups.value)+n.groups.value.length});let a=[Fs,Vs,Ds,Bs,js,_s,Ns,Us];a.push(As);for(let l of a)if(l(i,n.groups.value,e))break}return s}return!1}function fa(t){var e;if((e=t.httpRegion.request)==null?void 0:e.headers){let r=Le(t.httpRegion.request.headers);if(tt(r))return!0}return!1}var Gs=[{name:"name",description:"responses of a requests with a name are automatically added as variables and can be reused by other requests",completions:["${1}"]},{name:"debug",description:"enable debug log level"},{name:"description",description:"additional description of region",completions:["${1}"]},{name:"disabled",description:"requests can be disabled"},{name:"extension",description:"extension of file for save or openWith.",completions:["${1}"]},{name:"forceRef",description:"When the request is called, it is ensured that the referenced request is always called beforehand",completions:["${1}"]},{name:"import",description:"reference Requests from other files.",completions:["${1}"]},{name:"injectVariables",description:"Inject Variables in request body (needed because of compatibility with Intellij)."},{name:"jwt",description:"supports auto decode of jwt token."},{name:"language",description:"language id of the response view",completions:["${1}"]},{name:"loop",description:"allows multiple Invocations of a Request with different parameters.",completions:["for ${1} of ${2}","for ${1}","while ${1}"]},{name:"keepStreaming",description:"keep streaming until the user session is ended manually"},{name:"noLog",description:"prevent logging of request data in output console"},{name:"noCookieJar",description:"cookieJar support is disabled for this request"},{name:"noClientCert",description:"SSL client certificate is not send for this request"},{name:"noRejectUnauthorized",description:"all invalid SSL certificates will be ignored and no error will be thrown."},{name:"noResponseView",description:"prevent output in editor document."},{name:"noStreamingLog",description:"prevent logging of streaming request data in output console"},{name:"note",description:"shows a confirmation dialog before sending request",completions:["${1}"]},{name:"openWith",description:"viewType of custom editor to preview files",completions:["${1}"]},{name:"ref",description:"When the request is called, it is ensured that the referenced request is called beforehand",completions:["${1}"]},{name:"ratelimit",description:"allows throttling requests",completions:["minIdleTime ${1}","max ${1} expire ${2}","minIdleTime ${1} max ${2} expire ${3}"]},{name:"save",description:"If specified, the response will not be displayed but saved directly."},{name:"sleep",description:"wait specified millisecondes, before next step.",completions:["${1}"]},{name:"title",description:"additional title of region",completions:["${1}"]},{name:"verbose",description:"enable trace log level"}];function z(t,e,r){let o={parseResults:[]},s=t.next();for(;!s.done;){let n=!1;for(let i of e){let a=i(s.value,r);if(a){o.parseResults.push(a),n=!0;break}}if(!n)break;o.nextLine=s.value.line,s=t.next()}return o}function Y(t){return function(r){var s;let o=g.request.header.exec(r.textLine);if((s=o==null?void 0:o.groups)==null?void 0:s.key){let n=o.groups.key,i=o.groups.value,a=t[n];return a?Array.isArray(a)?a.push(i):t[n]=[a,i]:t[n]=i,{symbols:[{name:n,description:i,kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.length,children:[{name:n,description:"request header key",kind:"key",startLine:r.line,startOffset:r.textLine.indexOf(n),endLine:r.line,endOffset:r.textLine.indexOf(n)+n.length},{name:i,description:"request header value",kind:"value",startLine:r.line,startOffset:r.textLine.indexOf(i),endLine:r.line,endOffset:r.textLine.indexOf(i)+i.length}]}]}}return!1}}function Z(t){return function(r,o){var n;let s=g.request.headersSpread.exec(r.textLine);if((n=s==null?void 0:s.groups)==null?void 0:n.variableName){let i=new jt(s.groups.variableName,t);o.httpRegion.hooks.execute.addObjHook(l=>l.process,i);let a=r.textLine.trim();return{symbols:[{name:a,description:"header variable",kind:"requestHeader",startLine:r.line,startOffset:r.textLine.indexOf(a),endOffset:r.textLine.length,endLine:r.line}]}}return!1}}function ce(t){return function(r){if(g.request.urlLine.test(r.textLine)){let o=r.textLine.trim();return t(o),{symbols:[{name:o,description:"urlpart",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line}]}}return!1}}function Ks(t){return function(r){if(g.request.queryLine.test(r.textLine)){let o=r.textLine.trim();return t(o),{symbols:[{name:o,description:"query",kind:"url",startLine:r.line,startOffset:r.textLine.indexOf(o),endOffset:r.textLine.length,endLine:r.line}]}}return!1}}function X(t,e){return Qt(t,e,g.meta.comment)}async function ao(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&ha(o.value.textLine)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=ga(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"websocket request-line",kind:"requestLine",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},u={};i.request.headers=u;let p=z(r,[X,Y(u),Z((d,b)=>{var y;return Object.assign((y=b.request)==null?void 0:y.headers,d)}),ce(d=>i.request.url+=d)],e);if(p){l.nextParserLine=p.nextLine||l.nextParserLine;for(let d of p.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...d.symbols)}return e.httpRegion.hooks.execute.addObjHook(d=>d.process,new Dt),l}return!1}function ga(t,e){let r=g.stream.eventSourceLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"SSE"},symbol:{name:r.groups.url,description:"EventSource url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function ha(t){var e,r;return K(t)?!1:!!((r=(e=g.stream.eventSourceLine.exec(t))==null?void 0:e.groups)==null?void 0:r.url)}async function lo(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&ba(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=ya(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"grpc request-line",kind:"requestLine",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},u={};i.request.headers=u;let p=z(r,[X,Y(u),Z((d,b)=>{var y;return Object.assign((y=b.request)==null?void 0:y.headers,d)}),ce(d=>i.request.url+=d)],e);if(p){l.nextParserLine=p.nextLine||l.nextParserLine;for(let d of p.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...d.symbols)}return e.httpRegion.hooks.execute.addObjHook(d=>d.process,new Vt),l}return!1}function ya(t,e){let r=g.grpc.grpcLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"GRPC"},symbol:{name:r.groups.url,description:"grpc url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}};let o=g.grpc.grpcProtocol.exec(t);if(o&&o.length>1&&o.groups)return{request:{url:o.groups.url,method:"GRPC"},symbol:{name:o.groups.url,description:"grpc url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function ba(t,e){var r,o,s,n;return K(t)?!1:((o=(r=g.grpc.grpcLine.exec(t))==null?void 0:r.groups)==null?void 0:o.url)?!0:e.request?!1:(n=(s=g.grpc.grpcProtocol.exec(t))==null?void 0:s.groups)==null?void 0:n.url}async function uo(t,e){let r=t();if(e.httpRegion.metaData.noGqlParsing)return!1;let o=await wa(r);if(o){let s={fragments:xa(e)};return e.httpRegion.request?(s.query=o.gql,o.name&&(s.operationName=va(o.name),e.httpRegion.metaData.name||(e.httpRegion.metaData.name=o.name)),e.httpRegion.hooks.execute.addObjHook(n=>n.process,new Mt(s))):o.name&&(s.fragments[o.name]=o.gql),{nextParserLine:o.endLine,symbols:[{name:"gql",description:"gql",kind:"gql",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset}]}}return!1}function va(t){return t&&t.trim().split(" ").filter(e=>!!e&&!e.startsWith("@")).pop()}function xa(t){let e=t.data.gql;return e||(e={},t.data.gql=e),e}async function wa(t){var r,o,s;let e=t.next();if(!e.done){let n=e.value.line,i=g.gql.fileImport.exec(e.value.textLine);if(i&&((r=i.groups)==null?void 0:r.fileName)){let u=i.groups.fileName;return{startLine:n,endLine:n,endOffset:e.value.textLine.length,name:i.groups.name||i.groups.fileName,gql:p=>ne(u,p,d=>f.readFile(d,"utf-8"))}}let a=g.gql.query.exec(e.value.textLine);if(a)return Ws(e.value,t,(o=a.groups)==null?void 0:o.name);let l=g.gql.fragment.exec(e.value.textLine);if(l)return Ws(e.value,t,(s=l.groups)==null?void 0:s.name)}return!1}function Ws(t,e,r){let o=e.next(),s={endLine:t.line,endOffset:t.textLine.length},n=[t.textLine];for(;!o.done;){if(s={endLine:o.value.line,endOffset:o.value.textLine.length},g.emptyLine.test(o.value.textLine))return q(x({name:r,startLine:t.line},s),{gql:F(n)});n.push(o.value.textLine),o=e.next()}return q(x({name:r,startLine:t.line},s),{gql:F(n)})}async function po(t,{httpRegion:e}){let r=t();if(e.request){let o=Ra(r);if(o)return e.hooks.execute.addObjHook(s=>s.process,new Nt(o.data)),{nextParserLine:o.endLine,symbols:[{name:"Intellij Script",description:"Intellij Script",kind:"script",startLine:o.startLine,startOffset:0,endLine:o.endLine,endOffset:o.endOffset}]}}return!1}function Ra(t){var r,o;let e=t.next();if(!e.done){let s=e.value.line,n=g.intellij.import.exec(e.value.textLine);if((r=n==null?void 0:n.groups)==null?void 0:r.fileName)return{startLine:s,endLine:s,endOffset:e.value.textLine.length,data:{fileName:n.groups.fileName}};let i=g.intellij.scriptSingleLine.exec(e.value.textLine);if((o=i==null?void 0:i.groups)==null?void 0:o.script)return{startLine:s,endLine:s,endOffset:e.value.textLine.length,data:{script:i.groups.script,lineOffset:s}};if(g.intellij.scriptStart.exec(e.value.textLine)){e=t.next();let l=[];for(;!e.done;){if(g.intellij.scriptEnd.test(e.value.textLine))return{startLine:s,endLine:e.value.line,endOffset:e.value.textLine.length,data:{script:F(l),lineOffset:s}};l.push(e.value.textLine),e=t.next()}}}return!1}var ka=S(require("@grpc/grpc-js")),Js=S(require("chalk")),Qs=S(require("got"));async function co(t,{httpRegion:e,httpFile:r}){var n;let o=t(),s=o.next();if(!s.done){let i=g.javascript.scriptStart.exec(s.value.textLine);if(i==null?void 0:i.groups){let a=s.value.line;s=o.next();let l=[];for(;!s.done;){if(g.javascript.scriptEnd.test(s.value.textLine)){let u={script:F(l),lineOffset:a},p=((n=i.groups)==null?void 0:n.modifier)==="+";switch(i.groups.event){case"request":Ha(p?r.hooks:e.hooks,u);break;case"streaming":Pa(p?r.hooks:e.hooks,u);break;case"response":Sa(p?r.hooks:e.hooks,u);break;case"after":Oa(p?r.hooks:e.hooks,u);break;case"responseLogging":La(p?r.hooks:e.hooks,u);break;default:Ca(p?r.hooks:e.hooks,u);break}return{nextParserLine:s.value.line,symbols:[{name:"script",description:"nodejs script",kind:"script",startLine:a,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length}]}}l.push(s.value.textLine),s=o.next()}}}return!1}function Pa(t,e){t.onStreaming.addHook("js",async r=>{await Ge(e,r,"streaming")})}function Ca(t,e){t.execute.addHook("js",r=>Ge(e,r))}function Ha(t,e){t.onRequest.addHook("js",async(r,o)=>{await Ge(e,o,"request")})}function Sa(t,e){t.onResponse.addHook("js",async(r,o)=>{o.variables.response=r,await Ge(e,o,"response")})}function La(t,e){t.responseLogging.addHook("js",async(r,o)=>{let s=o.variables.response;o.variables.response=r,await Ge(e,o,"responseLogging"),o.variables.response=s})}function Oa(t,e){t.execute.addInterceptor(new mo(e))}var mo=class{constructor(e){this.scriptData=e}async afterLoop(e){return await Ge(this.scriptData,e.args[0],"after")}};async function Ge(t,e,r){h(e,r?`execute javascript (@${r})`:"execute javascript");let o=await je(t.script,{fileName:e.httpFile.fileName,context:x({request:e.request,sleep:pe,test:ct(e),httpFile:e.httpFile,httpRegion:e.httpRegion,console:e.scriptConsole},e.variables),lineOffset:t.lineOffset,require:x({httpyac:fo,chalk:Js.default,got:Qs.default,"@grpc/grpc-js":ka},e.require),deleteVariable:s=>mt(s,e)});return o&&V(o,e),!o.$cancel}var zt=class extends Ne{constructor(){super(["md","markdown","mdown","mkdn","mdtxt","mdtext","text","rmd"],/^```\s*(http|rest)$/iu,/^```\s*$/u)}};async function go({httpRegion:t}){if(t.metaData.note){let e=t.metaData.note||`Are you sure you want to send the request ${dt(t)}?`;t.hooks.execute.addInterceptor({beforeLoop:()=>O.showNote(e)})}}async function yo(t,{httpRegion:e}){var s;let o=t().next();if(!o.done){let n=o.value.textLine,i=g.outputRedirection.exec(n);if(i&&((s=i.groups)==null?void 0:s.fileName)){let a=i.groups.fileName,l=!!i.groups.force;return e.hooks.onResponse.addHook("outputRedirection",async(u,p)=>{try{if(u.rawBody){let d=await qa(a,l,p.httpFile.fileName);d?await f.writeBuffer(d,u.rawBody):c.debug(`file ${a} not found`)}}catch(d){c.error(`output redirection failed for ${a}`,d)}}),{nextParserLine:o.value.line,symbols:[{name:i.groups.key,description:i.groups.value,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length}]}}}return!1}async function qa(t,e,r){let o=await ho(t,r);if(!e&&await f.exists(o)){let s=t.lastIndexOf(".");if(s>0&&s<t.length-2){let n=t.slice(0,s),i=t.slice(s+1),a=1;for(o=await ho(`${n}-${a}.${i}`,r);await f.exists(o);)o=await ho(`${n}-${a++}.${i}`,r)}}return o}async function ho(t,e){if(!await f.isAbsolute(t)){let r=f.dirname(e);if(r)return f.joinPath(r,t)}return t}async function bo(t,e){let r=t();if(e.httpRegion.request){let o=Ta(e),s=r.next();if(!s.done&&(o.rawBody.length>0||!K(s.value.textLine))){o.rawBody.push($a(s.value.textLine));let n=[];return!o.symbol||o.symbol.endLine!==s.value.line-1?(o.symbol={name:"request body",description:"request body",kind:"requestBody",startLine:s.value.line,startOffset:0,endLine:s.value.line,endOffset:s.value.textLine.length},n.push(o.symbol)):(o.symbol.endLine=s.value.line,o.symbol.endOffset=s.value.textLine.length),{nextParserLine:s.value.line,symbols:n}}}return!1}function Ta(t){let e=t.data.request_body;return e||(e={rawBody:[]},t.data.request_body=e),e}function Ea(t){let e=t.data.request_body;return e&&delete t.data.request_body,e}function $a(t){let e=g.request.fileImport.exec(t);return e&&e.length===4&&e.groups?{fileName:e.groups.fileName,injectVariables:!!e.groups.injectVariables,encoding:Aa(e.groups.encoding)}:t}function Ia(t){return["ascii","utf8","utf-8","utf16le","ucs2","ucs-2","base64","latin1","binary","hex"].indexOf(t)>=0}function Aa(t){return t&&Ia(t)?t:"utf8"}async function vo(t){let e=Ea(t);t.httpRegion.request&&!!e&&(Fa(e.rawBody),t.httpRegion.hooks.execute.addInterceptor(new Gt(e.rawBody)))}function Fa(t){for(;t.length>0&&K(t[t.length-1]);)t.pop();if(t.length>0){let e=t[t.length-1];m(e)&&/\s*<--->\s*/u.test(e)&&t.pop()}}async function xo(t,e){let r=t(),o=r.next();if(!o.done&&Da(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let s={name:o.value.textLine,description:"http request-line",kind:"requestLine",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length},n=[s],{request:i,requestSymbols:a}=ja(o.value.textLine,o.value.line);e.httpRegion.request=i,s.children=a;let l={nextParserLine:o.value.line,symbols:n},u={};i.headers=u;let p=z(r,[X,Y(u),Z((d,b)=>{var y;return Object.assign((y=b.request)==null?void 0:y.headers,d)}),Ks(d=>i.url+=d),ce(d=>i.url+=d)],e);if(p){l.nextParserLine=p.nextLine||l.nextParserLine;for(let d of p.parseResults)n.push(...d.symbols)}if(e.httpRegion.hooks.execute.addObjHook(d=>d.process,new Bt),e.httpRegion.request.headers){let d=$(e.httpRegion.request.headers,"content-type");m(d)&&(e.httpRegion.request.contentType=Ze(d))}return l}return!1}function ja(t,e){let r=[],o=g.request.requestLine.exec(t);return o&&o.length>1&&o.groups?(r.push({name:o.groups.method,description:"request method",kind:"requestHeader",startLine:e,startOffset:t.indexOf(o.groups.method),endLine:e,endOffset:t.indexOf(o.groups.method)+o.groups.method.length},{name:o.groups.url,description:"request url",kind:"url",startLine:e,startOffset:t.indexOf(o.groups.url),endLine:e,endOffset:t.length}),{request:{url:o.groups.url,method:St(o.groups.method)?o.groups.method:"GET",http2:o.groups.version?["1.1","1.0"].indexOf(o.groups.version)<0:void 0},requestSymbols:r}):(r.push({name:t.trim(),description:"request url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}),{request:{url:t.trim(),method:"GET"},requestSymbols:r})}function Da(t,e){var r,o;return K(t)?!1:e.request?!!((o=(r=g.request.requestLine.exec(t))==null?void 0:r.groups)==null?void 0:o.method):!0}async function wo(t,{httpRegion:e}){var s;let o=t().next();if(!o.done){let n=o.value.textLine,i=g.responseRef.exec(n);if(i&&((s=i.groups)==null?void 0:s.fileName))return e.responseRefs||(e.responseRefs=[]),e.responseRefs.push(i.groups.fileName),{nextParserLine:o.value.line,symbols:[{name:i.groups.key,description:i.groups.value,kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length}]}}return!1}async function Ro(t,e){var s,n,i,a;let r=t(),o=r.next();if(!o.done){let l=e.data.httpResponseSymbol;if(l)return l.body.push(o.value.textLine),l.symbol.endLine=o.value.line,l.symbol.endOffset=o.value.textLine.length,{nextParserLine:o.value.line,symbols:[]};let u=g.responseLine.exec(o.value.textLine);if(u&&((s=u.groups)==null?void 0:s.statusCode)){e.httpRegion.response={protocol:`HTTP/${u.groups.httpVersion||"1.1"}`,httpVersion:u.groups.httpVersion,statusCode:+u.groups.statusCode,statusMessage:u.groups.statusMessage,headers:{}};let p={name:"response",description:"response",kind:"response",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length};for(o=r.next();!o.done;){p.endLine=o.value.line,p.endOffset=o.value.textLine.length;let d=g.request.header.exec(o.value.textLine);if(((n=d==null?void 0:d.groups)==null?void 0:n.key)&&((i=d==null?void 0:d.groups)==null?void 0:i.value))e.httpRegion.response.headers=Object.assign((a=e.httpRegion.response)==null?void 0:a.headers,{[d.groups.key]:d.groups.value});else break;o=r.next()}return e.data.httpResponseSymbol={symbol:p,body:[]},{nextParserLine:p.endLine,symbols:[p]}}}return!1}async function ko(t){if(t.data.httpResponseSymbol){if(t.httpRegion.response&&t.data.httpResponseSymbol.body.length>0){let e=t.httpRegion.response,r=F(t.data.httpResponseSymbol.body);e.body=r,e.rawBody=Buffer.from(r),e.headers&&(e.contentType=Le(e.headers)),at(e)}delete t.data.httpResponseSymbol}}var zs=require("@grpc/grpc-js"),Ys=require("@grpc/proto-loader");async function Po(t,e){var s;let r=t(),o=r.next();if(!o.done){let n=g.grpc.proto.exec(o.value.textLine);if((s=n==null?void 0:n.groups)==null?void 0:s.fileName){let i=new Ct(n.groups.fileName),l=[{name:o.value.textLine,description:"proto import",kind:"proto",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length}],u={nextParserLine:o.value.line,symbols:l},p=z(r,[X,Y(i.loaderOptions),Z((d,b)=>{var y;return Object.assign((y=b.options.protoDefinitions)==null?void 0:y[i.fileName].loaderOptions,d)})],e);if(p){u.nextParserLine=p.nextLine||u.nextParserLine;for(let d of p.parseResults)l.push(...d.symbols)}return e.httpRegion.hooks.execute.addObjHook(d=>d.process,new Co(i)),e.httpRegion.hooks.execute.addInterceptor(new Ho(i)),u}}return!1}var Co=class{constructor(e){this.protoDefinition=e;this.id="protoImport"}async process(e){var o;h(e,`import proto ${this.protoDefinition.fileName}`);let r=(o=e.options.protoDefinitions)==null?void 0:o[this.protoDefinition.fileName];if(r){let s=await this.convertLoaderOptions(r.loaderOptions,e);r.packageDefinition=await ne(this.protoDefinition.fileName,e,async n=>{var l,u;let i=f.fsPath(n);if(i)return await(0,Ys.load)(i,s);let a=`file ${n} has not scheme file`;(u=(l=O).showWarnMessage)==null||u.call(l,a),c.warn(a)}),r.packageDefinition&&(r.grpcObject=(0,zs.loadPackageDefinition)(r.packageDefinition))}return!0}async convertLoaderOptions(e,r){var n,i;let o=x({},e),s=F(Object.entries(o).filter(([,a])=>m(a)).map(([a,l])=>`${a}: ${l},`));try{Object.assign(o,await Q(`{${s}}`,r))}catch(a){let l=`proto-loader options convert failed: ${s}`;(i=(n=O).showWarnMessage)==null||i.call(n,l),c.warn(l,a)}return o}},Ho=class{constructor(e){this.protoDefinition=e;this.id="protoCreate"}async beforeLoop(e){let r=e.args[0];return r.options.protoDefinitions=Object.assign({},r.options.protoDefinitions,{[this.protoDefinition.fileName]:{fileName:this.protoDefinition.fileName,loaderOptions:x({},this.protoDefinition.loaderOptions)}}),!0}};var Zs=require("hookpoint"),So="variable";async function Lo(t,{httpRegion:e}){let o=t().next();if(!o.done){let s=o.value.textLine,n=g.variable.exec(s);if(n&&n.groups&&n.groups.key&&n.groups.value){let i=n.groups.key,a=n.groups.value;return e.hooks.execute.hasHook(So)||e.hooks.execute.addInterceptor(new Xs),e.hooks.execute.addHook(So,l=>(l.options.replaceVariables=!0,V({[i]:a},l),!0)),{nextParserLine:o.value.line,symbols:[{name:n.groups.key,description:n.groups.value,kind:"variable",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[{name:n.groups.key,description:"key",kind:"key",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.key),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.key)+n.groups.key.length},{name:n.groups.value,description:"value",kind:"value",startLine:o.value.line,startOffset:o.value.textLine.indexOf(n.groups.value),endLine:o.value.line,endOffset:o.value.textLine.indexOf(n.groups.value)+n.groups.value.length}]}]}}}return!1}var Xs=class{constructor(){this.id="variable"}async beforeTrigger(e){var o;let r=e.args[0];return((o=e.hookItem)==null?void 0:o.id)!==So&&r.options.replaceVariables&&(await this.replaceAllVariables(r),delete r.options.replaceVariables),!0}async replaceAllVariables(e){for(let[r,o]of Object.entries(e.variables)){let s=await de(o,"Variable",e);s!==Zs.HookCancel&&(e.variables[r]=s)}return!0}};async function Oo(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&Va(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=Ma(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"WebSocket request-line",kind:"requestLine",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},u={};i.request.headers=u;let p=z(r,[X,Y(u),Z((d,b)=>{var y;return Object.assign((y=b.request)==null?void 0:y.headers,d)}),ce(d=>i.request.url+=d)],e);if(p){l.nextParserLine=p.nextLine||l.nextParserLine;for(let d of p.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...d.symbols)}return e.httpRegion.hooks.execute.addObjHook(d=>d.process,new Wt),l}return!1}function Ma(t,e){let r=g.stream.websocketLine.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"WS"},symbol:{name:r.groups.url,description:"WebSocket Url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}};let o=g.stream.websocketProtocol.exec(t);if(o&&o.length>1&&o.groups)return{request:{url:o.groups.url,method:"WS"},symbol:{name:o.groups.url,description:"WebSocket Url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function Va(t,e){var r,o,s,n;return K(t)?!1:((o=(r=g.stream.websocketLine.exec(t))==null?void 0:r.groups)==null?void 0:o.url)?!0:e.request?!1:(n=(s=g.stream.websocketProtocol.exec(t))==null?void 0:s.groups)==null?void 0:n.url}var jo={};ae(jo,{provider:()=>ee,replacer:()=>B});var ee={};ae(ee,{provideConfigEnvironments:()=>Ba,provideConfigVariables:()=>_a,provideDotenvEnvironments:()=>Na,provideDotenvVariables:()=>Ua,provideIntellijEnvironments:()=>Ka,provideIntellijGlobalVariables:()=>Qa,provideIntellijVariables:()=>Wa,provideLastResponseVariables:()=>za});var en="$default",tn="$shared";async function Ba(t){var e;return((e=t.config)==null?void 0:e.environments)?Object.keys(t.config.environments).filter(r=>[en,tn].indexOf(r)<0):[]}async function _a(t,e){var o;let r=[];if((o=e.config)==null?void 0:o.environments){let s=e.config.environments;r.push(s[tn]),t&&t.length>0?r.push(...t.map(n=>s[n])):r.push(s[en])}return Object.assign({},...r)}var rn=require("dotenv"),on=[".env"];async function Na(t){var s;let e=[],r=process.env.HTTPYAC_ENV;if(r&&m(r)){let n=await M(r,t.httpFile.rootDir);n&&e.push(...await f.readdir(n))}if((s=t.config)==null?void 0:s.envDirName){let n=await M(t.config.envDirName,t.httpFile.rootDir);n&&e.push(...await f.readdir(n))}let o=f.dirname(t.httpFile.fileName);return o&&await Ot(o,t.httpFile.rootDir,async n=>{e.push(...await f.readdir(n))}),e.filter(n=>n.startsWith(".env")||n.endsWith(".env")).filter(n=>on.indexOf(n)<0).map(n=>n.startsWith(".env")?n.slice(5):n.slice(0,n.length-4))}async function Ua(t,e){var i;let r=Ga(t),o=[],s=process.env.HTTPYAC_ENV;if(s&&m(s)){let a=await M(s,e.httpFile.rootDir);a&&o.push(...await qo(r,a))}if((i=e.config)==null?void 0:i.envDirName){let a=await M(e.config.envDirName,e.httpFile.rootDir);a&&o.push(...await qo(r,a))}let n=f.dirname(e.httpFile.fileName);if(n){let a=[];await Ot(n,e.httpFile.rootDir,async l=>{a.unshift(...await qo(r,l))}),o.push(...a)}return Object.assign({},...o)}function Ga(t){let e=[...on];if(t)for(let r of t)e.push(`${r}.env`,`.env.${r}`);return e}async function qo(t,e){let r=await f.readdir(e),o=t.filter(n=>r.indexOf(n)>=0),s=[];for(let n of o){let i=f.joinPath(e,n);try{let a=await f.readFile(i,"utf-8"),l=(0,rn.parse)(a);s.push(l)}catch{c.trace(`${f.toString(e)}/${n} not found`)}}return s}async function Ka(t){return Object.keys(await sn(t))}async function sn(t){var n;let e=[],r=i=>i.endsWith(".env.json"),o=process.env.HTTPYAC_ENV;if(o&&m(o)){let i=await M(o,t.httpFile.rootDir);i&&e.push(...await Zt(i,r))}if(t.httpFile.rootDir&&e.push(...await Zt(t.httpFile.rootDir,r)),(n=t.config)==null?void 0:n.envDirName){let i=await M(t.config.envDirName,t.httpFile.rootDir);i&&e.push(...await Zt(i,r));let a=f.dirname(t.httpFile.fileName);a&&e.push(...await Zt(a,r))}let s={};for(let i of e){let a=await Ja(i);if(a)for(let[l,u]of Object.entries(a))s[l]?(f.toString(i).endsWith("private.env.json")||c.warn(`Multiple files with environment ${l} were found.`),Object.assign(s[l],u)):s[l]=u}return s}async function Zt(t,e){return(await f.readdir(t)).filter(e).map(o=>f.joinPath(t,o))}async function Wa(t,e){let r=await sn(e),o=[];if(t)for(let s of t)o.push(r[s]);return Object.assign({},...o)}async function Ja(t){try{if(await f.exists(t)){let e=await f.readFile(t,"utf-8");return JSON.parse(e)}}catch(e){c.trace(`${t} not found`),c.trace(e)}}async function Qa(t){let e=U(t),r=E.getUserSession(`intellij_global_cache_${e}`);return(r==null?void 0:r.variables)||{}}async function za(){let t=E.getUserSession("last_response");return(t==null?void 0:t.response)?{response:t.response}:{}}var B={};ae(B,{awsAuthVariableReplacer:()=>Ya,basicAuthVariableReplacer:()=>Za,clientCertVariableReplacer:()=>Xa,digestAuthVariableReplacer:()=>tl,escapeVariableReplacer:()=>il,getOAuth2Response:()=>rr,hostVariableReplacer:()=>al,intellijVariableReplacer:()=>ll,isOpenIdInformation:()=>Ao,oauth2VariableReplacer:()=>yl,replaceJavascriptExpressions:()=>xl,replaceVariableNames:()=>wl,restClientVariableReplacer:()=>Rl,showInputBoxVariableReplacer:()=>kl,showQuickpickVariableReplacer:()=>Pl});var nn=S(require("aws4")),an=require("url");async function Ya(t,e,r){var s;let{request:o}=r;if(e.toLowerCase()==="authorization"&&m(t)&&W(o)&&(o==null?void 0:o.url)){let n=g.auth.aws.exec(t);if(n&&n.groups&&n.groups.accessKeyId&&n.groups.secretAccessKey){h(r,"get AWS Authorization");let i={accessKeyId:n.groups.accessKeyId,secretAccessKey:n.groups.secretAccessKey,sessionToken:n.groups.token},a=new an.URL(o.url),l={method:o.method,headers:o.headers,host:a.host,path:a.pathname,region:n.groups.region,service:n.groups.service},u=await nn.default.sign(l,i);return Object.assign(o,{http2:!1}),(s=u.headers)==null?void 0:s.Authorization}}return t}async function Za(t,e){if(e.toLowerCase()==="authorization"&&m(t)){let r=g.auth.basicColon.exec(t)||g.auth.basic.exec(t);if(r&&r.groups&&r.groups.user&&r.groups.password)return`Basic ${Buffer.from(`${r.groups.user}:${r.groups.password}`).toString("base64")}`}return t}var un=require("url");async function Xa(t,e,r){var i,a,l,u;let{request:o,httpRegion:s,httpFile:n}=r;if(m(t)&&W(o)&&!s.metaData.noClientCert){if(e==="Url"&&((i=r.config)==null?void 0:i.clientCertificates)){let p=el(t);if(p){let d=(a=r.config)==null?void 0:a.clientCertificates[p.host];d&&await ln(o,d,n)}}else if(e.toLowerCase().endsWith("clientcert")){let p=g.auth.clientCert.exec(t);if(((l=p==null?void 0:p.groups)==null?void 0:l.cert)||((u=p==null?void 0:p.groups)==null?void 0:u.pfx)){await ln(o,{cert:p.groups.cert,key:p.groups.key,pfx:p.groups.pfx,passphrase:p.groups.passphrase},n);return}}}return t}function el(t){try{return new un.URL(t)}catch{return}}async function ln(t,e,r){let o=f.dirname(r.fileName);t.https=Object.assign({},t.https,{certificate:await To(e.cert,o),key:await To(e.key,o),pfx:await To(e.pfx,o),passphrase:e.passphrase})}async function To(t,e){if(t)if(m(t)){let r=await M(t,e);if(r)return await f.readBuffer(r)}else return await f.readBuffer(t)}var pn=require("crypto"),dn=require("url"),cn=require("uuid");async function tl(t,e,{request:r}){if(e.toLowerCase()==="authorization"&&m(t)&&W(r)){let o=g.auth.digest.exec(t);if(o&&o.groups&&o.groups.user&&o.groups.password){r.hooks||(r.hooks={}),r.hooks.afterResponse||(r.hooks.afterResponse=[]),r.hooks.afterResponse.push(rl(o.groups.user,o.groups.password));return}}return t}function rl(t,e){return function(o,s){let n=o.headers["www-authenticate"];if(o.statusCode===401&&n&&n.toLowerCase().startsWith("digest")){let i=new dn.URL(o.url),a={qop:"",algorithm:"",realm:"",nonce:"",opaque:""};nl(a,n);let l=/(^|,)\s*auth\s*($|,)/u.test(a.qop)&&"auth",u=l&&"00000001",p=l&&(0,cn.v4)().replace(/-/gu,""),d=sl(a.algorithm,t,e,a.realm,a.nonce,p),b=ht(`${o.request.options.method}:${i.pathname}`),y=ht(l?`${d}:${a.nonce}:${u}:${p}:${l}:${b}`:`${d}:${a.nonce}:${b}`);return s({headers:{authorization:`Digest ${ol({username:t,realm:a.realm,nonce:a.nonce,uri:i.pathname,qop:l,response:y,nc:u,cnonce:p,algorithm:a.algorithm,opaque:a.opaque})}`}})}return o}}function ol(t){let e=[];for(let[r,o]of Object.entries(t))o&&(["qop","nc","algorithm"].indexOf(r)>=0?e.push(`${r}=${o}`):e.push(`${r}="${o}"`));return e.join(", ")}function ht(t){return(0,pn.createHash)("md5").update(t).digest("hex")}function sl(t,e,r,o,s,n){let i=ht(`${e}:${o}:${r}`);return n&&(t==null?void 0:t.toLowerCase())==="md5-sess"?ht(`${i}:${s}:${n}`):i}function nl(t,e){for(let r of e.split(",")){let o=/([a-z0-9_-]+)=(?:"([^"]+)"|([a-z0-9_-]+))/giu.exec(r);o&&(t[o[1]]=o[2]||o[3])}}async function il(t){if(m(t)){let e=/(?:\\\{){2}([^}{2}]+)(?:\\\}){2}/gu,r,o=t;for(;m(o)&&(r=e.exec(t))!==null;){let[s,n]=r;o=o.replace(s,`{{${n}}}`)}return o}return t}async function al(t,e,{variables:r,request:o}){if(m(t)&&"Url"===e&&t.startsWith("/")){if(r.host)return`${r.host}${t}`;let s=$(o==null?void 0:o.headers,"Host");if(m(s)){let[,n]=s.toString().split(":");return`${n==="443"||n==="8443"?"https":"http"}://${s}${t}`}}return t}var mn=require("uuid");async function ll(t){if(!m(t))return t;let e,r=t;for(;(e=g.javascript.scriptSingleLine.exec(t))!==null;){let[o,s]=e,n=null;switch(s.trim()){case"$uuid":n=(0,mn.v4)();break;case"$timestamp":n=Date.now();break;case"$randomInt":n=Math.floor(Math.random()*1e3);break;default:n=null;break}n&&(r=r.replace(o,`${n}`))}return r}var fn=S(require("lodash/get")),gn=require("url"),ul="http://localhost:3000/callback";function _(t,e,r){let o=t[`${e}_${r}`]||(0,fn.default)(t,`${e}.${r}`),s=It(o,t);return m(s)?s:""}function pl(t,e,r,o){let s=_(t,e,r);try{return new gn.URL(s||o)}catch{throw new Error(`Expected a valid URL, but received ${s}`)}}function Eo(t,e){return t?{variablePrefix:t,authorizationEndpoint:_(e,t,"authorizationEndpoint"),deviceCodeEndpoint:_(e,t,"deviceCodeEndpoint"),tokenEndpoint:_(e,t,"tokenEndpoint"),clientId:_(e,t,"clientId"),clientSecret:_(e,t,"clientSecret"),responseType:_(e,t,"responseType"),responseMode:_(e,t,"responseMode"),audience:_(e,t,"audience"),scope:_(e,t,"scope"),username:_(e,t,"username"),password:_(e,t,"password"),subjectIssuer:_(e,t,"subjectIssuer"),redirectUri:pl(e,t,"redirectUri",ul),keepAlive:["true","1",!0].indexOf(_(e,t,"keepAlive"))<0,useAuthorizationHeader:["false","0",!1].indexOf(_(e,t,"useAuthorizationHeader"))<0,useDeviceCodeClientSecret:["true","1",!0].indexOf(_(e,t,"useDeviceCodeClientSecret"))>=0}:!1}function te(t,e){var o,s;let r=[];for(let n of e)Object.entries(t).some(([i,a])=>i===n&&!!a)||r.push(n);if(r.length>0){let n=`missing configuration: ${r.map(i=>`${t.variablePrefix}_${i}`).join(", ")}`;return c.error(n),(s=(o=O).showErrorMessage)==null||s.call(o,n),!1}return!0}var yn=require("http"),me=[],Ke,Xt,er=0;function tr(t){me.push(t),dl(Number(t.url.port),t.url.pathname)}function xe(t){let e=me.findIndex(r=>r.id===t);e>=0&&me.splice(e,1),me.length===0&&vn(60)}function bn(){Xt&&(clearTimeout(Xt),Xt=!1,er=0)}function vn(t){bn();let e=t*1e3;er=new Date().getTime()+e,Xt=setTimeout(()=>xn(),e)}function xn(){for(let t of me)t.reject();me.length=0,Ke&&(bn(),Ke.close(t=>{t?c.error(t):c.debug("http server closed")}),Ke=!1)}function dl(t,e){vn(600),Ke||(c.debug(`open http server on port ${t}`),Ke=(0,yn.createServer)((r,o)=>{try{let s="invalid",n=500,i=[];if(r.url){let a=cl(r.url),l=r.url.split("?")[0];if(l===e){let u=me.find(p=>p.id===a.state);if(u){let p=u.resolve(a);i.push(yt(p.message,p.valid)),p.valid&&(n=200,xe(u.id)),s=p.statusMessage}else i.push(yt("invalid state received",!1)),i.push(`
                <script>
                  if(window.location.hash){
                    window.document.querySelector('.js-message').remove();
                    window.location.replace(\`\${window.location.href.substring(0,window.location.href.indexOf('#'))}?\${window.location.hash.substring(1)}\`);
                  }
                <\/script>
                <noscript>
                  ${yt("Please enable javascript for redirect or replace fragment (#) with query (?)",!1)}
                </noscript>
              `),s="invalid state received"}else if(l.startsWith("/reject")){let u=me.find(p=>p.id===a.id);u?(u.reject(),xe(a.id),n=200,s="listener removed",i.push(yt(`${u.name} removed`,!0))):s="listener not found"}else l.startsWith("/shutdown")&&(xn(),i.push(yt("server closed",!0)),n=200,s="server was shut down")}i.push(ml()),o.setHeader("Content-Type","text/html"),o.writeHead(n,s),o.end(hn(i.join("")))}catch(s){c.error(s),o.end(hn(`${s}`))}}),Ke.listen(t))}function cl(t){return t.slice(t.indexOf("?")+1).split("&").reduce((e,r)=>{let[o,s]=r.split("=");return e[o]=s,e},{})}function yt(t,e){return`
<div class="card js-message ${e?"card--success":"card--error"}">
  <h3 class="card__title">${e?"success":"error"}</h3>
  <div class="card__message">${t}</div>
</div>`}function ml(){let t=[];return me.length>0&&t.push(...me.map(e=>`
      <div class="card">
        <h3 class="card__title">open requests</h3>
        <div class="card__message">${e.name}</div>
        <div class="card__actions">
          <a href="/reject?id=${e.id}">remove</a>
        </div>
      </div>`)),er>0&&t.push(`
    <div class="card">
      <h3 class="card__title">Server Status</h3>
      <div class="card__message">automatic shutdown in ${fl(Math.floor((er-new Date().getTime())/1e3))}</div>
      <div class="card__actions">
        <a href="/shutdown">shutdown</a>
      </div>
    </div>`),t.join("")}function fl(t){if(t>0){let e=Math.trunc(t/60),r=t%60;return e>0?r>0?`${e}minute${e>1?"s":""} ${r} seconds`:`${e} minute${e>1?"s":""}`:`${t} seconds`}return"-"}function hn(t){return`
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>httpYac</title>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <style>
    :root{
      --light: #FAFAFA;
      --success: #4CAF50;
      --success-dark: #43A047;
      --error: #D32F2F;
      --error-dark: #C62828;
      --link-light: #E1F5FE;
      --link: #00B0FF;
      --link-dark: #0091EA;
    }
      body{
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        background-color: var(--light);
        display:flex;
        align-items: center;
        flex-direction: column;
      }

      .card{
        border-radius: 4px;
        background-color: #FFF;
        box-shadow: 0px 2px 1px -1px rgb(0 0 0 / 20%), 0px 1px 1px 0px rgb(0 0 0 / 14%), 0px 1px 3px 0px rgb(0 0 0 / 12%);
        width: 22rem;
        padding: .5rem;
        margin: auto;
        display: flex;
        flex-direction: column;
        justify-content: center;
        margin: 2rem;
      }

      .card--success{
        border-bottom: 1rem solid var(--success);
      }
      .card--success:hover{
        border-bottom: 1rem solid var(--success-dark);
      }

      .card--error{
        border-bottom: 1rem solid var(--error);
      }
      .card--error:hover{
        border-bottom: 1rem solid var(--error-dark);
      }
      .card__title{
        margin: 0 .5rem;
      }
      .card__message{
        padding: 0 .5rem;
        word-break: break-word;
      }
      .card__actions{
        padding: 1rem 0;
      }
      a {
          color: var(--link);
          text-decoration:none;
          border-radius:3px;
          cursor:pointer;
          text-transform: uppercase;
          padding: .5rem;
      }
      a:focus {
        outline-color: var(--link);
        color: var(--link);
      }
      a:hover, a:active {
          color: var(--link-dark);
          background-color: var(--link-light);
      }
    </style>
  </head>
  <body>
  <img src="https://raw.githubusercontent.com/AnWeber/vscode-httpyac/master/icon.png" alt="HttpYac Logo" />
${t}
</body>
</html>
`}async function re(t,e,r){if(t){let o=new Date().getTime();t.headers||(t.headers={"content-type":"application/x-www-form-urlencoded"}),t.headers&&e.config.useAuthorizationHeader?t.headers.authorization=`Basic ${Buffer.from(`${e.config.clientId}:${e.config.clientSecret}`).toString("base64")}`:t.body=`${t.body}&${D({client_id:e.config.clientId,client_secret:e.config.clientSecret})}`;let s=await(r==null?void 0:r.httpClient(t,{showProgressBar:!1}));if(s&&($e(r)&&await G(s,r),s.statusCode<400&&m(s.body)))return bt(JSON.parse(s.body),o,e)}return!1}function bt(t,e,r){if(gl(t)){let o=Oe(t.access_token);return o&&c.debug(JSON.stringify(o,null,2)),q(x({},r),{type:"OAuth2",time:e,accessToken:t.access_token,expiresIn:t.expires_in,refreshToken:t.refresh_token,refreshExpiresIn:t.refresh_expires_in,timeSkew:(o==null?void 0:o.iat)?Math.floor(e/1e3)-o.iat:0})}return!1}function gl(t){let e=t;return e&&!!e.access_token&&!!e.expires_in}var wn=S(require("open")),Rn=class{supportsFlow(e){return["authorization_code","code"].indexOf(e)>=0}getCacheKey(e){return te(e,["tokenEndpoint","authorizationEndpoint","clientId","clientSecret"])?`authorization_code_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?new Promise((s,n)=>{let i=Ie();try{h(r,"execute OAuth2 authorization_code flow");let a=`${e.authorizationEndpoint}${e.authorizationEndpoint.indexOf("?")>0?"&":"?"}${D({client_id:e.clientId,scope:e.scope||"openid",response_type:"code",state:i,audience:e.audience,redirect_uri:e.redirectUri.toString()})}`,l;r.progress&&(l=r.progress.register(()=>{xe(i),n(new Error("process canceled"))})),tr({id:i,url:e.redirectUri,name:`authorization for ${e.clientId}: ${e.authorizationEndpoint}`,resolve:u=>{if(u.code&&u.state===i){l&&l();let p=re({url:e.tokenEndpoint,method:"POST",body:D({grant_type:"authorization_code",scope:e.scope,code:u.code,redirect_uri:e.redirectUri.toString()})},{config:e,id:o,title:`authorization_code: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"authorization_code"}},r);return s(p),{valid:!0,message:"code received.",statusMessage:"code and state valid. starting code exchange"}}return u.error_description?{valid:!1,message:decodeURIComponent(u.error_description),statusMessage:"no access_token received"}:{valid:!1,message:"no code received",statusMessage:"no code received"}},reject:n}),h(r,`autorization_code browser authentication pending: ${a}`),(0,wn.default)(a)}catch(a){xe(i),n(a)}}):!1}},kn=new Rn;var Pn=class{supportsFlow(e){return["client_credentials","client"].indexOf(e)>=0}getCacheKey(e){return te(e,["tokenEndpoint","clientId","clientSecret"])?`client_credentials_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?(h(r,"execute OAuth2 client_credentials flow"),re({url:e.tokenEndpoint,method:"POST",body:D({grant_type:"client_credentials",scope:e.scope})},{config:e,id:o,title:`clientCredentials: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"client_credentials"}},r)):!1}},Cn=new Pn;var Hn=S(require("open")),Sn=class{supportsFlow(e){return["device_code","device"].indexOf(e)>=0}getCacheKey(e){return te(e,["tokenEndpoint","deviceCodeEndpoint","clientId"])?`device_code_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){var s,n,i,a;let o=this.getCacheKey(e);if(o){h(r,"execute device_code authorization flow");let l=new Date().getTime(),u=await this.requestDeviceAuthorization(r,e);if(u&&$e(r)&&await G(u,r),u&&u.statusCode===200&&m(u.body)){h(r,"device_code received");let p=JSON.parse(u.body),d=p.interval?Number(p.interval)*1e3:5e3;for(Number.isNaN(d)&&(d=5e3),this.showUserCode(p);new Date().getTime()-l<Number(p.expires_in)*1e3;)try{if(await pe(d),(n=(s=r.progress)==null?void 0:s.isCanceled)==null?void 0:n.call(s))return c.trace("process canceled by user"),!1;let b=new Date().getTime(),y=await this.authenticateUser(r,e,p);if(y&&m(y.body)){let C=JSON.parse(y.body);if(y.statusCode===200)return h(r,"accessToken received"),await this.logResponse(y,r),bt(C,b,{config:e,id:o,title:`deviceCode: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"device_code"}});if(h(r,`device code ${C.error}`),["slow_down","authorization_pending"].indexOf(C.error)>=0)(C.error==="slow_down"||y.statusCode===408)&&(d+=5e3,c.debug(`DeviceCode Flow increase interval: ${d}`));else{if(C.error&&["access_denied","expired_token","bad_verification_code"].indexOf(C.error)>=0)return c.debug(`DeviceCode Flow aborted: ${C.error_description||""}`),await this.logResponse(y,r),!1;if(await((a=(i=O).showWarnMessage)==null?void 0:a.call(i,`Unknown error code ${C.error}`,"Continue","Cancel"))==="Cancel")return await this.logResponse(y,r),!1}}else return c.debug("device code received invalid response"),!1}catch(b){return c.debug(b),!1}}}return!1}async logResponse(e,r){$e(r)&&await G(e,r)}async authenticateUser(e,r,o){return await(e==null?void 0:e.httpClient({url:r.tokenEndpoint,method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:D({client_id:r.clientId,grant_type:"urn:ietf:params:oauth:grant-type:device_code",device_code:o.device_code})},{showProgressBar:!1}))}async requestDeviceAuthorization(e,r){return await(e==null?void 0:e.httpClient({url:r.deviceCodeEndpoint,method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:D({client_id:r.clientId,client_secret:r.useDeviceCodeClientSecret?r.clientSecret:void 0,scope:r.scope||"openid"})},{showProgressBar:!1}))}showUserCode(e){let r=e.message||`To sign in, use a web browser to open the page ${e.verification_uri_complete} and enter the code ${e.user_code} to authenticate.`;c.info(r),c.info(`Verification_Uri: ${e.verification_uri_complete||e.verification_uri}`),c.info(`User_Code: ${e.user_code}`);let o=async()=>{var s,n;await((n=(s=O).setClipboard)==null?void 0:n.call(s,e.user_code)),await(0,Hn.default)(e.verification_uri_complete||e.verification_uri)};O.showInformationMessage?O.showInformationMessage(r,"Open").then(s=>{s&&o()}):o()}},Ln=new Sn;var On=S(require("open")),qn=class{supportsFlow(e){return["implicit","hybrid"].indexOf(e)>=0}getCacheKey(e){return te(e,["tokenEndpoint","authorizationEndpoint","clientId"])?`implicit_${e.clientId}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?new Promise((s,n)=>{h(r,"execute OAuth2 implicit flow");let i=Ie();try{let a=`${e.authorizationEndpoint}${e.authorizationEndpoint.indexOf("?")>0?"&":"?"}${D({client_id:e.clientId,scope:e.scope||"openid",response_type:e.responseType||"token",nonce:Ie(),state:i,response_mode:e.responseMode,audience:e.audience,redirect_uri:e.redirectUri.toString()})}`,l;r.progress&&(l=r.progress.register(()=>{xe(i),n(new Error("progress cancel"))})),tr({id:i,url:e.redirectUri,name:`authorization for ${e.clientId}: ${e.authorizationEndpoint}`,resolve:u=>{if(u.state===i){if(u.code){let p=re({url:e.tokenEndpoint,method:"POST",body:D({grant_type:"authorization_code",scope:e.scope,code:u.code,redirect_uri:e.redirectUri.toString()})},{config:e,id:o,title:`implicit: ${e.clientId}`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"implicit"}},r);return s(p),{valid:!0,message:"code received.",statusMessage:"code valid. starting code exchange"}}if(u.access_token){l&&l();let p=bt(u,new Date().getTime(),{config:e,id:o,title:`implicit: ${e.clientId}`,description:e.tokenEndpoint,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"implicit"}});return s(p),{valid:!0,message:"access_token received.",statusMessage:"access_token and state valid."}}}return u.error_description?{valid:!1,message:decodeURIComponent(u.error_description),statusMessage:"no access_token received"}:{valid:!1,message:"no access_token received",statusMessage:"no access_token received"}},reject:n}),c.trace(`open browser: ${a}`),h(r,`implicit browser authentication pending: ${a}`),(0,On.default)(a)}catch(a){xe(i),n(a)}}):!1}},Tn=new qn;var En=class{isTokenExpired(e,r,o){return typeof o<"u"?e+1e3*(o-r)<new Date().getTime():!1}async perform(e,r){return this.isTokenExpired(e.time,e.timeSkew,e.expiresIn)?e.refreshToken&&!this.isTokenExpired(e.time,e.timeSkew,e.refreshExpiresIn)?(h(r,"execute OAuth2 refresh_token flow"),re({url:e.config.tokenEndpoint,method:"POST",body:D({grant_type:"refresh_token",refresh_token:e.refreshToken})},{config:e.config,id:e.id,title:e.title,description:e.description,details:{clientId:e.config.clientId,tokenEndpoint:e.config.tokenEndpoint,grantType:"refresh_token"}},r)):!1:e}},$o=new En;var $n=class{supportsFlow(e){return["password"].indexOf(e)>=0}getCacheKey(e){return te(e,["tokenEndpoint","clientId","clientSecret","username","password"])?`password_${e.clientId}_${e.username}_${e.tokenEndpoint}`:!1}async perform(e,r){let o=this.getCacheKey(e);return o?(h(r,"execute OAuth2 password flow"),re({url:e.tokenEndpoint,method:"POST",body:D({grant_type:"password",scope:e.scope,username:e.username,password:e.password})},{config:e,id:o,title:`password flow: ${e.username} (${e.clientId})`,description:`${e.variablePrefix} - ${e.tokenEndpoint}`,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"password",username:e.username}},r)):!1}},In=new $n;var An=S(require("encodeurl")),Io=class{static getCacheKey(e){return te(e,["tokenEndpoint","clientId","clientSecret"])?`${e.tokenEndpoint}_${e.clientId}`:!1}static async perform(e,r,o){if(r){h(o,"execute OAuth2 token exchange flow");let s=Oe(r.accessToken);return re({url:e.tokenEndpoint,method:"POST",body:D({grant_type:"urn:ietf:params:oauth:grant-type:token-exchange",requested_token_type:"urn:ietf:params:oauth:token-type:access_token",subject_token_type:"urn:ietf:params:oauth:token-type:access_token",scope:e.scope||"openid",subject_issuer:e.subjectIssuer||(s==null?void 0:s.iss),subject_token:(0,An.default)(r.accessToken)})},{config:e,id:r.id,title:`${r.title} (token exchange)`,description:r.description,details:{clientId:e.clientId,tokenEndpoint:e.tokenEndpoint,grantType:"urn:ietf:params:oauth:grant-type:token-exchange"}},o)}return!1}};var Fn=require("hookpoint");async function yl(t,e,r){if(e.toLowerCase()==="authorization"&&m(t)){let o=g.auth.oauth2.exec(t);if(o&&o.groups){let s=o.groups.flow||"client_credentials";h(r,`get OAuth2 Authorization (${s})`);let n=await rr(s,o.groups.variablePrefix,r,o.groups.tokenExchangePrefix);return n?`Bearer ${n.accessToken}`:Fn.HookCancel}}return t}async function rr(t,e,r,o){let s=Eo(e||"oauth2",r.variables),n=Eo(o,r.variables),i=vl(t);if(i&&s){let a=i.getCacheKey(s);if(a){let l=bl(a,n||s);if(E.removeUserSession(a),l&&(c.trace(`openid refresh token flow used: ${a}`),l=await $o.perform(l,r)),l||(c.trace(`openid flow ${t} used: ${a}`),l=await i.perform(s,r),l&&n&&(l=await Io.perform(n,l,r))),l)return c.trace(`openid flow ${t} finished`),r.variables.oauth2Session=l,E.setUserSession(l),jn(a,r.httpClient,r.variables),l}}}function bl(t,e){let r=E.userSessions.find(o=>o.id===t);return Ao(r)&&JSON.stringify(r.config)===JSON.stringify(e)?r:!1}function Ao(t){let e=t;return!!(e==null?void 0:e.accessToken)}function vl(t){return[kn,Cn,Ln,In,Tn].find(r=>r.supportsFlow(t))}function jn(t,e,r){let o=E.userSessions.find(s=>s.id===t);if(Ao(o)&&o.refreshToken&&o.config.keepAlive){let s=setTimeout(async()=>{let n=await $o.perform(o,{httpClient:e,variables:r});n&&(c.trace(`token ${n.title} refreshed`),E.setUserSession(n),jn(t,e,r))},(o.expiresIn-o.timeSkew)*1e3);o.delete=()=>clearTimeout(s)}}async function xl(t,e,r){if(!m(t))return t;let o,s,n=t;for(;s!==n;)for(s=n;(o=g.javascript.scriptSingleLine.exec(s))!==null;){let[i,a]=o;try{let l=ot(await Q(a,r));l&&(n=n.replace(i,l))}catch(l){e==="Variable"?(c.trace(`variable ${a} not defined`),c.trace(l)):(c.warn(`expression ${a} throws error`),c.warn(l))}}return n}async function wl(t,e,r){if(!m(t))return t;let o,s,n=t;for(;s!==n;)for(s=n;(o=g.javascript.scriptSingleLine.exec(s))!==null;){let[i,a]=o,l=ot(r.variables[a]);l&&(n=n.replace(i,l))}return n}var We=S(require("dayjs")),Fo=S(require("dayjs/plugin/utc")),Dn=require("uuid");We.default.extend(Fo.default);async function Rl(t,e,{variables:r}){var n,i,a,l,u,p,d,b,y,C,w,k;if(!m(t))return t;let o,s=t;for(;(o=g.javascript.scriptSingleLine.exec(t))!==null;){let[H,T]=o,R=T.trim(),I=null;if(R==="$guid")I=(0,Dn.v4)();else if(R.startsWith("$randomInt")){let P=/^\$randomInt\s*(?<min>-?\d+)?\s*(?<max>-?\d+)?\s*$/u.exec(R);if(P&&((n=P.groups)==null?void 0:n.min)&&((i=P.groups)==null?void 0:i.max)){let A=Number((a=P.groups)==null?void 0:a.min),Qe=Number((l=P.groups)==null?void 0:l.max);if(!Number.isNaN(A)&&!Number.isNaN(Qe)){if(A>Qe){let pi=Qe;Qe=A,A=pi}I=`${Math.floor(Math.random()*(Qe-A))+A}`}}}else if(R.startsWith("$timestamp")){let P=/^\$timestamp(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(R);if(P){We.default.extend(Fo.default);let A=We.default.utc();((u=P.groups)==null?void 0:u.offset)&&((p=P.groups)==null?void 0:p.option)&&(A=A.add(Number(P.groups.offset),P.groups.option)),I=`${A.unix()}`}}else if(R.startsWith("$datetime")){let P=/^\$datetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(R);if((d=P==null?void 0:P.groups)==null?void 0:d.type){let A=We.default.utc();((b=P.groups)==null?void 0:b.offset)&&((y=P.groups)==null?void 0:y.option)&&(A=A.add(Number(P.groups.offset),P.groups.option)),P.groups.type==="rfc1123"?I=A.toDate().toUTCString():P.groups.type==="iso8601"?I=A.toISOString():I=A.format(P.groups.type.slice(1,P.groups.type.length-1))}}else if(R.startsWith("$localDatetime")){let P=/^\$localDatetime\s(?<type>rfc1123|iso8601|'.+'|".+")(?:\s(?<offset>-?\d+)\s(?<option>y|Q|M|w|d|h|m|s|ms))?/u.exec(R);if((C=P==null?void 0:P.groups)==null?void 0:C.type){let A=We.default.utc().local();((w=P.groups)==null?void 0:w.offset)&&((k=P.groups)==null?void 0:k.option)&&(A=A.add(Number(P.groups.offset),P.groups.option)),P.groups.type==="rfc1123"?I=A.locale("en").format("ddd, DD MMM YYYY HH:mm:ss ZZ"):P.groups.type==="iso8601"?I=A.format():I=A.format(P.groups.type.slice(1,P.groups.type.length-1))}}else R.startsWith("$processEnv")?I=process.env[R.slice(11).trim()]:R.startsWith("$dotenv")&&(I=r[R.slice(7).trim()]);I&&(s=s.replace(H,`${I}`))}return s}var Vn=require("hookpoint"),Mn={};async function kl(t){var o;if(!m(t))return t;let e,r=t;for(;(e=g.javascript.scriptSingleLine.exec(t))!==null;){let[s,n]=e,a=/^\$(?<type>(input|password))\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))?\s*$/u.exec(n);if((o=a==null?void 0:a.groups)==null?void 0:o.placeholder){let l=a.groups.placeholder,u=a.groups.type,p=await O.showInputPrompt(l,Mn[l]||a.groups.value,u==="password");if(p)Mn[l]=p,r=r.replace(s,`${p}`);else return Vn.HookCancel}}return r}var Bn=require("hookpoint");async function Pl(t){var o,s;if(!m(t))return t;let e,r=t;for(;(e=g.javascript.scriptSingleLine.exec(r))!==null;){let[n,i]=e,a=/^\$pick\s*(?<placeholder>[^$]*)(\$value:\s*(?<value>.*))\s*$/u.exec(i);if(((o=a==null?void 0:a.groups)==null?void 0:o.placeholder)&&((s=a==null?void 0:a.groups)==null?void 0:s.value)){let l=a.groups.placeholder,u=a.groups.value,p=await O.showListPrompt(l,u.split(","));if(p&&r)r=r.replace(n,`${p}`);else return Bn.HookCancel}}return r}function _n(t){Cl(t.hooks.onRequest),Hl(t.hooks.onResponse),Sl(t.hooks.parse),Ll(t.hooks.parseEndRegion),Ol(t.hooks.provideVariables),ql(t.hooks.provideEnvironments),Tl(t.hooks.replaceVariable),t.hooks.execute.addInterceptor(new Ft),t.hooks.execute.addInterceptor(new At)}function Cl(t){t.addHook("attachDefaultHeaders",Kr),t.addHook("setEnvRequestOptions",eo),t.addHook("requestVariableReplacer",to),t.addHook("transformRequestBody",ro)}function Hl(t){t.addHook("addAdditionalBody",at),t.addHook("responseAsVariable",Xr)}function Sl(t){t.addInterceptor(new zt),t.addInterceptor(new Jt),t.addHook("meta",io),t.addHook("comment",so),t.addHook("variable",Lo),t.addHook("javascript",co),t.addHook("intellijScript",po),t.addHook("gql",uo),t.addHook("proto",Po),t.addHook("grpc",lo),t.addHook("websocket",Oo),t.addHook("eventSource",ao),t.addHook("request",xo),t.addHook("outputRedirection",yo),t.addHook("responseRef",wo),t.addHook("response",Ro),t.addHook("requestBody",bo)}function Ll(t){t.addHook("registerCancelExecutionInterceptor",oo),t.addHook("note",go),t.addHook("response",ko),t.addHook("requestBody",vo)}function Ol(t){t.addHook("config",ee.provideConfigVariables),t.addHook("dotenv",ee.provideDotenvVariables),t.addHook("intellij",ee.provideIntellijVariables),t.addHook("intellijGlobal",ee.provideIntellijGlobalVariables),t.addHook("last_response",ee.provideLastResponseVariables)}function ql(t){t.addHook("config",ee.provideConfigEnvironments),t.addHook("dotenv",ee.provideDotenvEnvironments),t.addHook("intellij",ee.provideIntellijEnvironments)}function Tl(t){t.addHook("showInputBox",B.showInputBoxVariableReplacer),t.addHook("showQuickPick",B.showQuickpickVariableReplacer),t.addHook("restClientDynamic",B.restClientVariableReplacer),t.addHook("intellijDynamic",B.intellijVariableReplacer),t.addHook("host",B.hostVariableReplacer),t.addHook("name",B.replaceVariableNames),t.addHook("javascript",B.replaceJavascriptExpressions),t.addHook("oauth2",B.oauth2VariableReplacer),t.addHook("aws",B.awsAuthVariableReplacer),t.addHook("clientCertificate",B.clientCertVariableReplacer),t.addHook("basicAuth",B.basicAuthVariableReplacer),t.addHook("digestAuth",B.digestAuthVariableReplacer),t.addHook("escape",B.escapeVariableReplacer)}var Nn=require("mqtt"),Do=class{constructor(){this.id="websocketClient"}async process(e){let{request:r}=e;return cr(r)?await se(async()=>r.url?(h(e,`request MQTT ${r.url}`),await this.requestMQTT(r,e)):!1,e):!1}async requestMQTT(e,r){let{httpRegion:o}=r;return await new Promise((s,n)=>{var H,T;if(!e.url){n(new Error("request url undefined"));return}let i=x({clientId:`httpyac_${Math.random().toString(16).slice(2,8)}`,username:$(e.headers,"username"),password:$(e.headers,"password"),keepalive:ur($(e.headers,"keepalive")),clean:!!$(e.headers,"clean")},e.options);o.metaData.noRejectUnauthorized&&(i.rejectUnauthorized=!1);let a={request:e},l=[],u=[],p;r.progress&&(p=(T=(H=r.progress)==null?void 0:H.register)==null?void 0:T.call(H,()=>{d.end(!0,void 0,R=>R&&c.error("error on close",R))}));let d=(0,Nn.connect)(e.url,i),b={mqttClient:d};d.on("connect",R=>{c.debug("MQTT connect",R),a.protocol="MQTT",a.headers=R.properties}),d.on("reconnect",()=>c.debug("MQTT reconnect")),d.on("message",(R,I,P)=>{c.debug("MQTT message",I,P),l.push({topic:R,message:I.toString("utf-8"),date:new Date}),r.httpRegion.metaData.noStreamingLog||r.logStream&&u.push(r.logStream("MQTT",R,I))}),d.on("packetsend",R=>c.debug("MQTT packetsend",R)),d.on("packetreceive",R=>c.debug("MQTT packetreceive",R)),d.on("disconnect",R=>c.debug("MQTT disconnect",R)),d.on("close",()=>c.debug("MQTT close")),d.on("offline",()=>c.debug("MQTT offline")),d.on("error",R=>{c.debug("MQTT error",R),l.push(R)}),d.on("end",async()=>{c.debug("MQTT end"),p&&p(),qe(b,r),await Promise.all(u),s(this.toMergedHttpResponse(l,a))});let y=Se(e.headers,"subscribe");y&&this.subscribeToTopics(d,y,this.toQoS($(e.headers,"qos")));let C=Se(e.headers,"publish");C&&this.publishToTopics(d,C,e);let w=Se(e.headers,"topic");w&&(this.subscribeToTopics(d,w,this.toQoS($(e.headers,"qos"))),this.publishToTopics(d,w,e)),V(b,r),r.httpFile.hooks.onStreaming.merge(r.httpRegion.hooks.onStreaming).trigger(r).then(()=>d.end()).catch(R=>n(R))})}subscribeToTopics(e,r,o){for(let s of r)e.subscribe(s,{qos:o})}publishToTopics(e,r,o){if(o.body)for(let s of r)e.publish(s,o.body,{qos:this.toQoS($(o.headers,"qos")),retain:!!$(o.headers,"retain")},n=>n&&c.error("publish error",n))}toQoS(e){switch(e){case"2":return 2;case"1":return 1;default:return 0}}toMergedHttpResponse(e,r){let o=JSON.stringify(e,null,2),s=Buffer.isBuffer(e)?e:Buffer.from(o),n=q(x({statusCode:0,protocol:"MQTT",contentType:{mimeType:"application/json",charset:"UTF-8",contentType:"application/json; charset=utf-8"},headers:{}},r),{body:o,rawBody:s}),i=e.find(a=>this.isMQTTError(a));return i&&this.isMQTTError(i)&&(n.statusCode=i.errno||-1,n.statusMessage=i.code),n}isMQTTError(e){return e instanceof Error}};var Un=/^\s*(mqtt|mqtts)\s*(?<url>.+?)\s*$/iu,Gn=/^\s*mqtt(s)?:\/\/(?<url>.+?)\s*$/iu;async function Kn(t,e){var s,n;let r=t(),o=r.next();if(!o.done&&$l(o.value.textLine,e.httpRegion)){if(e.httpRegion.request)return{endRegionLine:o.value.line-1,nextParserLine:o.value.line-1,symbols:[]};let i=El(o.value.textLine,o.value.line);if(!i)return!1;e.httpRegion.request=i.request;let a={name:o.value.textLine,description:"MQTT request-line",kind:"requestLine",startLine:o.value.line,startOffset:0,endLine:o.value.line,endOffset:o.value.textLine.length,children:[i.symbol]},l={nextParserLine:o.value.line,symbols:[a]},u={};i.request.headers=u;let p=z(r,[X,Y(u),Z((d,b)=>{var y;return Object.assign((y=b.request)==null?void 0:y.headers,d)}),ce(d=>i.request.url+=d)],e);if(p){l.nextParserLine=p.nextLine||l.nextParserLine;for(let d of p.parseResults)(n=(s=l.symbols)==null?void 0:s.push)==null||n.call(s,...d.symbols)}return e.httpRegion.hooks.execute.addObjHook(d=>d.process,new Do),l}return!1}function El(t,e){let r=Un.exec(t);if(r&&r.length>1&&r.groups)return{request:{url:r.groups.url,method:"MQTT"},symbol:{name:r.groups.url,description:"MQTT Url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}};let o=Gn.exec(t);if(o&&o.length>1&&o.groups)return{request:{url:o.groups.url,method:"MQTT"},symbol:{name:o.groups.url,description:"MQTT Url",kind:"url",startLine:e,startOffset:0,endLine:e,endOffset:t.length}}}function $l(t,e){var r,o,s,n;return K(t)?!1:((o=(r=Un.exec(t))==null?void 0:r.groups)==null?void 0:o.url)?!0:e.request?!1:(n=(s=Gn.exec(t))==null?void 0:s.groups)==null?void 0:n.url}function Wn(t){t.hooks.parse.addHook("mqtt",Kn,{before:["request"]})}Ve.core=_n;Ve.mqtt=Wn;var Mo=require("hookpoint");async function or(t){let e=!1;return Dr(t)?e=await Al(t):Mr(t)?e=await Fl(t):e=await jl(t),e}async function Al(t){if(!t.httpRegion.metaData.disabled){let e=await Je(t);if(await Me(e))return await ve(e,!0)}return!1}async function Fl(t){let e=await Je(t);if(await Me(e)){for(let r of t.httpRegions)if(!r.metaData.disabled){let o=q(x({},e),{httpRegion:r});if(!await ve(o,!1))return!1}return!0}return!1}async function jl(t){let e=await Je(t);for(let r of t.httpFile.httpRegions){if(r.metaData.disabled){c.debug(`${r.symbol.name} is disabled`);continue}if(r.request&&t.httpRegionPredicate&&!t.httpRegionPredicate(r)){c.debug(`${r.symbol.name} disabled by predicate`);continue}let o=q(x({},e),{httpRegion:r});await ve(o)}return!0}async function Je(t){return Object.assign(t,{variables:await Jn(t),httpClient:Ar(t),options:{}})}async function Jn(t){var o;t.config=await ft(t.config,(o=t.httpFile)==null?void 0:o.rootDir);let e=await t.httpFile.hooks.provideVariables.trigger(t.httpFile.activeEnvironment,t);if(e===Mo.HookCancel)return{};let r=Object.assign({},...e,t.variables);return c.debug(r),r}async function Dl(t){var r;t.config=await ft(t.config,(r=t.httpFile)==null?void 0:r.rootDir);let e=await t.httpFile.hooks.provideEnvironments.trigger(t);return e!==Mo.HookCancel&&e.length>0?e.reduce((o,s)=>{for(let n of s)o.indexOf(n)<0&&o.push(n);return o},[]).sort():[]}var _o={};ae(_o,{createProgram:()=>ui,execute:()=>tu});var Te=require("fs"),vt=S(require("inquirer")),we=require("path");function Qn(){Vl(),_l(),Ml()}function Ml(){process.platform==="win32"&&(le.ok="[x]",le.error="[-]")}function Vl(){f.isAbsolute=async t=>(0,we.isAbsolute)(f.toString(t)),f.dirname=t=>(0,we.dirname)(f.toString(t)),f.hasExtension=(t,...e)=>e.indexOf((0,we.extname)(f.toString(t)))>=0,f.joinPath=(t,e)=>(0,we.join)(f.toString(t),e),f.exists=async t=>{try{return!!await Te.promises.stat(f.toString(t))}catch{return!1}},f.readFile=async(t,e)=>{let r=f.fsPath(t);if(r)return Te.promises.readFile(r,e);throw new Error("No valid path for cli")},f.readBuffer=async t=>{let e=f.fsPath(t);if(e){let r=(0,Te.createReadStream)(e);return Bl(r)}throw new Error("No valid path for cli")},f.writeBuffer=(t,e)=>Te.promises.writeFile(f.toString(t),e),f.readdir=async t=>Te.promises.readdir(f.toString(t))}function Bl(t){return new Promise((e,r)=>{let o=[];t.on("data",s=>{Buffer.isBuffer(s)?o.push(s):o.push(Buffer.from(s))}),t.on("end",()=>e(Buffer.concat(o))),t.on("error",s=>r(s)),t.resume()})}function _l(){O.showNote=async function(e){return(await vt.default.prompt([{type:"confirm",name:"note",message:e}])).note},O.showInputPrompt=async function(e,r,o){return o?(await vt.default.prompt([{type:"password",name:"placeholder",message:e,mask:"*",default:r}])).placeholder:(await vt.default.prompt([{type:"input",name:"placeholder",message:e,default:r}])).placeholder},O.showListPrompt=async function(e,r){return(await vt.default.prompt([{type:"list",name:"placeholder",message:e,choices:r}])).placeholder},O.getClipboard=async function(){return await(await import("clipboardy")).default.read()},O.setClipboard=async function(e){await(await import("clipboardy")).default.write(e)}}var zn=require("commander");function Yn(){return new zn.Command("oauth2").description("generate oauth2 token").option("-f, --flow <flow>","flow used for oauth2 token generation","client_credentials").option("--prefix <prefix>","variable prefix used for variables").option("-e, --env  <env...>","list of environments").option("-o, --output <output>","output format of response (access_token, refresh_token, response)","access_token").option("--var  <variables...>","list of variables").action(Nl)}async function Nl(t){let e=new Be,r=await Je({httpFile:await e.initHttpFile("oauth2.http",{activeEnvironment:t.env,workingDir:process.cwd()}),variables:t.var?Object.fromEntries(t.var.map(s=>{let n=s.split("=");return[n[0],n.slice(1).join("=")]})):void 0}),o=await rr(t.flow,t.prefix,r);if(o)switch(t.output){case"response":console.info(JSON.stringify({access_token:o.accessToken,expires_in:o.expiresIn,refresh_token:o.refreshToken,refresh_expires_in:o.refreshExpiresIn},null,2));break;case"refresh_token":console.info(o.refreshToken);break;default:console.info(o.accessToken);break}else process.exitCode=1,console.info("no valid auth response")}function Vo(t){if(t.json)return 1e3;if(t.silent)return 100;if(t.verbose)return 1}function Bo(t,e){return t+e}function Zn(t,e){let r=[];for(let[s,n]of Object.entries(t))r.push(...n.map(i=>{var u,p,d,b,y,C,w,k,H,T;let a=e.output;return e["output-failed"]&&((p=(u=i.testResults)==null?void 0:u.some)==null?void 0:p.call(u,R=>!R.result))&&(a=e["output-failed"]),{fileName:s,response:Gl(i.response,a),name:(d=i.metaData)==null?void 0:d.name,title:(b=i.metaData)==null?void 0:b.title,description:(y=i.metaData)==null?void 0:y.description,line:i.symbol.startLine,testResults:i.testResults,summary:{totalTests:((C=i.testResults)==null?void 0:C.length)||0,failedTests:((k=(w=i.testResults)==null?void 0:w.filter)==null?void 0:k.call(w,R=>!R.result).length)||0,successTests:((T=(H=i.testResults)==null?void 0:H.filter)==null?void 0:T.call(H,R=>!!R.result).length)||0}}}));let o=r;return e.filter==="only-failed"&&(o=r.filter(s=>s.summary.failedTests>0)),{_meta:{version:"1.0.0"},requests:o,summary:{totalRequests:r.length,failedRequests:r.filter(s=>s.summary.failedTests>0).length,successRequests:r.filter(s=>s.summary.failedTests===0).length,totalTests:r.map(s=>s.summary.totalTests).reduce(Bo,0),failedTests:r.map(s=>s.summary.failedTests).reduce(Bo,0),successTests:r.map(s=>s.summary.successTests).reduce(Bo,0)}}}function Gl(t,e){var r;if(t)switch(delete t.rawHeaders,delete t.rawBody,delete t.prettyPrintBody,delete t.parsedBody,delete t.contentType,e){case"body":case"response":return delete t.request,t;case"short":return delete t.body,delete t.request,t;case"none":return;case"headers":return delete t.body,(r=t.request)==null||delete r.body,t;case"exchange":default:return t}}var ti=S(require("chalk")),ri=require("commander"),oi=require("fs"),si=S(require("inquirer")),ni=require("path");function ii(){return new ri.Command("send").description("send/ execute http files").argument("<fileName>","path to file or glob pattern").option("-a, --all","execute all http requests in a http file").option("-e, --env  <env...>","list of environments").option("--filter <filter>"," filter requests output (only-failed)").option("--insecure","allow insecure server connections when using ssl").option("-i --interactive","do not exit the program after request, go back to selection").option("--json","use json output").option("-l, --line <line>","line of the http requests").option("-n, --name <name>","name of the http requests").option("--no-color","disable color support").option("-o, --output <output>","output format of response (short, body, headers, response, exchange, none)").option("--output-failed <output>","output format of failed response (short, body, headers, response, exchange, none)").option("--raw","prevent formatting of response body").option("--quiet","").option("--repeat <count>","repeat count for requests",Xn).option("--repeat-mode <mode>","repeat mode: sequential, parallel (default)").option("-s, --silent","log only request").option("--timeout <timeout>","maximum time allowed for connections",Xn).option("--var  <variables...>","list of variables").option("-v, --verbose","make the operation more talkative").action(Kl)}async function Kl(t,e){let r=Wl(e),o=await Ql(t,e,r.config);if(o.length>0){let s=!0,n={};for(;e.interactive||s;){let i=await Yl(o,e),a=[];if(i)await or(Object.assign({processedHttpRegions:a},r,i)),n[f.toString(i.httpFile.fileName)]=[...a];else for(let l of o)!e.json&&r.scriptConsole&&o.length>1&&r.scriptConsole.info(`--------------------- ${l.fileName}  --`),await or(Object.assign({processedHttpRegions:a},r,{httpFile:l})),n[f.toString(l.fileName)]=[...a],a.length=0;if(s=!1,e.json||Object.keys(n).length>1||Object.entries(n).some(([,l])=>l.length>1)){let l=Zn(n,e);e.json?console.info(JSON.stringify(l,null,2)):r.scriptConsole&&(r.scriptConsole.info(""),r.scriptConsole.info(ti.default`{bold ${l.summary.totalRequests}} requests tested ({green ${l.summary.successRequests} succeeded}, {red ${l.summary.failedRequests} failed})`))}}}else console.error(`httpYac cannot find the specified file ${t}.`)}function Xn(t){if(t){let e=Number(t);if(!Number.isNaN(e))return e}}function Wl(t){return{repeat:t.repeat?{count:t.repeat,type:t["repeat-mode"]==="sequential"?0:1}:void 0,scriptConsole:new Ye({level:Vo(t),onlyFailedTests:t.filter==="only-failed"}),config:{log:{level:Vo(t)},request:{timeout:t.timeout,https:t.insecure?{rejectUnauthorized:!1}:void 0}},logStream:t.json?void 0:Xl(t),logResponse:t.json?void 0:eu(t),variables:t.var?Object.fromEntries(t.var.map(r=>{let o=r.split("=");return[o[0],o.slice(1).join("=")]})):void 0}}function Jl(t,e){if(t.length>0&&e.bail){let r={afterTrigger:async function(s){var a,l;let i=(l=(a=s.args[0].httpRegion.testResults)==null?void 0:a.find)==null?void 0:l.call(a,u=>!u.result);if(i)throw i.error||new Error("bail on failed test");return!0}};for(let o of t)o.httpRegions.forEach(s=>s.hooks.execute.addInterceptor(r))}}async function Ql(t,e,r){let o=[],s=new Be,n={workingDir:process.cwd(),activeEnvironment:e.env,config:r},i=await zl(t);for(let a of i){let l=await s.getOrCreate(a,async()=>await oi.promises.readFile(a,"utf8"),0,n);o.push(l)}return Jl(o,e),o}async function zl(t){let e={expandDirectories:{files:["*.rest","*.http"],extensions:["http","rest"]}},{globby:r}=await import("globby"),o=await r(t,e);return o&&o.length>0||ni.sep==="/"?o:await r(t.replace(/\\/gu,"/"),e)}async function Yl(t,e){if(t.length===1){let r=t[0],o=Zl(r,e);if(o)return{httpFile:r,httpRegion:o}}if(!e.all){let r={},o=t.length>1;for(let n of t){r[o?`${n.fileName}: all`:"all"]={httpFile:n};for(let i of n.httpRegions)if(i.request){let a=i.symbol.name;r[o?`${n.fileName}: ${a}`:a]={httpRegion:i,httpFile:n}}}let s=await si.default.prompt([{type:"list",name:"region",message:"please choose which region to use",choices:Object.entries(r).map(([n])=>n)}]);if(s.region&&r[s.region])return r[s.region]}return!1}function Zl(t,e){let r=!1;return e.name?r=t.httpRegions.find(o=>o.metaData.name===e.name)||!1:r=t.httpRegions.find(o=>e.line&&o.symbol.startLine<=e.line&&o.symbol.endLine>=e.line)||!1,r}function Xl(t){if(t.output!=="none")return async function(r,o,s){let n=Buffer.isBuffer(s)?s.toString("utf-8"):s;console.info(`${new Date().toLocaleTimeString()} - ${o}: `,n)}}function eu(t){let e=ei(t.output,t.filter==="only-failed",!t.raw);if(e)return gr(console.info,e,t["output-failed"]?ei(t["output-failed"],t.filter==="only-failed",!t.raw):void 0)}function ei(t,e,r){switch(t){case"body":return{responseBodyLength:0,responseBodyPrettyPrint:r,onlyFailed:e};case"headers":return{requestOutput:!0,requestHeaders:!0,responseHeaders:!0,onlyFailed:e};case"response":return{responseHeaders:!0,responseBodyPrettyPrint:r,responseBodyLength:0,onlyFailed:e};case"none":return;case"short":return{useShort:!0,onlyFailed:e};case"exchange":default:return{requestOutput:!0,requestHeaders:!0,responseBodyPrettyPrint:r,requestBodyLength:0,responseHeaders:!0,responseBodyLength:0,onlyFailed:e}}}var ai=require("commander"),li=require("path");async function ui(){let t=new ai.Command,e=await ut((0,li.join)(__dirname,"../package.json"));return t.version((e==null?void 0:e.version)||"0.0.1").description("httpYac - Quickly and easily send REST, SOAP, GraphQL and gRPC requests").addCommand(Yn()).addCommand(ii(),{isDefault:!0}),t}async function tu(t){try{Qn(),await(await ui()).parseAsync(t)}catch(e){throw console.error(e),process.exitCode||(process.exitCode=1),e}finally{process.exit()}}module.exports=bi(fo);0&&(module.exports={ActionType,ExecuteHook,HttpSymbolKind,LogLevel,OnRequestHook,OnResponseHook,OnStreaming,ParseEndRegionHook,ParseHook,ProtoDefinition,ProvideEnvironmentsHook,ProvideVariablesHook,RepeatOrder,ReplaceVariableHook,ResponseLoggingHook,VariableType,actions,cli,createEmptyProcessorContext,getEnvironments,getVariables,io,isProcessorContext,parser,send,store,testSymbols,utils,variables});
//# sourceMappingURL=index.js.map
